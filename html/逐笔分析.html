<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€ç¬”åˆ†æ ï¼ˆå¤§å¸ˆç‰ˆï¼‰</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .input-group label {
            font-weight: bold;
            min-width: 100px;
        }
        
        .input-group input {
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .input-group input#stockCode {
            width: 120px;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .custom-thresholds {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .threshold-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .threshold-item label {
            font-weight: bold;
            min-width: 80px;
        }
        
        .threshold-item input {
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 13px;
            width: 100px;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .analysis-summary, .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .summary-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .summary-item .value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .summary-item .label {
            color: #666;
            font-size: 14px;
        }
        
        .data-table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }
        
        .data-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        .order-type {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }
        
        .order-type.small {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .order-type.medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .order-type.large {
            background: #f8d7da;
            color: #721c24;
        }
        
        .order-type.super {
            background: #d4edda;
            color: #155724;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            text-align: center;
            display: none;
        }

        .progress-title {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 12px;
        }

        .progress-step {
            color: #999;
            padding: 5px 10px;
            border-radius: 15px;
            background: #f5f5f5;
            transition: all 0.3s ease;
        }

        .progress-step.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            font-weight: bold;
        }

        .progress-step.completed {
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .success {
            color: #155724;
            background: #d4edda;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pagination button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .pagination span {
            color: #666;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .results-container {
                grid-template-columns: 1fr;
            }
            
            .custom-thresholds {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
        .risk-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 1400px;
            text-align: center;
            color: #856404;
            font-size: 14px;
            line-height: 1.6;
        }

        .risk-warning strong {
            color: #dc3545;
            font-size: 16px;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>é€ç¬”åˆ†æï¼ˆå¤§å¸ˆç‰ˆï¼‰</h1>
            <div>è‚¡ç¥¨å†å²åˆ†ç¬”æ•°æ®åˆ†æ</div>
            <div style="font-size: 14px; margin-top: 5px;">ä½œè€…ï¼š267278466@qq.com</div>
        </div>
        
        <div class="control-panel">
            <div class="input-group">
                <label for="stockCode"><i class="fas fa-search"></i> è‚¡ç¥¨ä»£ç :</label>
                <input type="text" id="stockCode" placeholder="ä¾‹å¦‚: 000001, 600000" maxlength="10">
                
                <label for="tradeDate"><i class="fas fa-calendar"></i> äº¤æ˜“æ—¥æœŸ:</label>
                <input type="date" id="tradeDate">
                
                <button class="btn" onclick="analyzeStock()">
                    <i class="fas fa-chart-line"></i> å¼€å§‹åˆ†æ
                </button>
                
                <button class="btn" onclick="openBattleAnalysis()" style="margin-left: 10px; background: linear-gradient(135deg, #6f42c1, #e83e8c); border: none;">
                    <i class="fas fa-balance-scale"></i> å¤šç©ºåˆ†æ
                </button>
            </div>
            
            <h3><i class="fas fa-cog"></i> è‡ªå®šä¹‰åˆ†ææ ‡å‡† (å•ä½: ä¸‡å…ƒ)</h3>
            <div class="custom-thresholds">
                <div class="threshold-item">
                    <label>å°å•ä¸Šé™:</label>
                    <input type="number" id="smallThreshold" value="5" step="0.1" min="0">
                </div>
                <div class="threshold-item">
                    <label>ä¸­å•ä¸Šé™:</label>
                    <input type="number" id="mediumThreshold" value="20" step="0.1" min="0">
                </div>
                <div class="threshold-item">
                    <label>å¤§å•ä¸Šé™:</label>
                    <input type="number" id="largeThreshold" value="100" step="0.1" min="0">
                </div>
                <div class="threshold-item">
                    <label>ç‰¹å¤§å•ä¸‹é™:</label>
                    <input type="number" id="superThreshold" value="1000" step="1" min="100" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                    <small style="color: #666; font-size: 12px;">è‡ªåŠ¨è®¾ç½®ä¸º > å¤§å•ä¸Šé™</small>
                </div>
            </div>
            
        </div>
        
        <div id="loadingDiv" class="loading" style="display: none;">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>æ­£åœ¨è·å–æ•°æ®ï¼Œè¯·ç¨å€™...</p>
        </div>

        <div id="progressContainer" class="progress-container">
            <div class="progress-title">
                <i class="fas fa-chart-line"></i> åˆ†æä¸­...
            </div>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="progressText" class="progress-text">æ­£åœ¨åˆå§‹åŒ–...</div>
            <div class="progress-steps">
                <div id="step1" class="progress-step">è·å–åˆ†ç¬”æ•°æ®</div>
                <div id="step2" class="progress-step">åˆ†æä¹°å–æ–¹å‘</div>
                <div id="step3" class="progress-step">ç»Ÿè®¡è®¢å•åˆ†ç±»</div>
                <div id="step4" class="progress-step">è·å–å†å²æ•°æ®</div>
                <div id="step5" class="progress-step">ç”Ÿæˆå›¾è¡¨</div>
            </div>
        </div>
        
        <div id="errorDiv" class="error" style="display: none;"></div>
        <div id="successDiv" class="success" style="display: none;"></div>
        
        <div id="resultsContainer" style="display: none;">
            <div class="analysis-summary" style="margin-bottom: 30px;">
                <h3><i class="fas fa-chart-pie"></i> åˆ†ææ±‡æ€»</h3>
                <div class="summary-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 20px;">
                    <div class="summary-item">
                        <div class="value" id="totalTrades">-</div>
                        <div class="label">æ€»ç¬”æ•°</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="totalAmount">-</div>
                        <div class="label">æ€»æˆäº¤é¢(ä¸‡)</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="avgAmount">-</div>
                        <div class="label">å¹³å‡æˆäº¤é¢(ä¸‡)</div>
                    </div>
                    <div class="summary-item">
                        <div class="value" id="maxAmount">-</div>
                        <div class="label">æœ€å¤§æˆäº¤é¢(ä¸‡)</div>
                    </div>
                </div>

                <h4><i class="fas fa-arrow-up" style="color: #F44336;"></i> ä¹°å…¥æ±‡æ€»</h4>
                <div class="summary-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 20px;">
                    <div class="summary-item" style="border-left-color: #F44336;">
                        <div class="value" style="color: #F44336;">
                            <div><span id="buySuperOrders">-</span></div>
                            <div style="font-size: 0.8em; margin-top: 5px;"><span id="buySuperAmount">-</span>ä¸‡å…ƒ</div>
                        </div>
                        <div class="label">ä¹°å…¥ç‰¹å¤§å•</div>
                    </div>
                    <div class="summary-item" style="border-left-color: #F44336;">
                        <div class="value" style="color: #F44336;">
                            <div><span id="buyLargeOrders">-</span></div>
                            <div style="font-size: 0.8em; margin-top: 5px;"><span id="buyLargeAmount">-</span>ä¸‡å…ƒ</div>
                        </div>
                        <div class="label">ä¹°å…¥å¤§å•</div>
                    </div>
                    <div class="summary-item" style="border-left-color: #F44336;">
                        <div class="value" style="color: #F44336;">
                            <div><span id="buyMediumOrders">-</span></div>
                            <div style="font-size: 0.8em; margin-top: 5px;"><span id="buyMediumAmount">-</span>ä¸‡å…ƒ</div>
                        </div>
                        <div class="label">ä¹°å…¥ä¸­å•</div>
                    </div>
                    <div class="summary-item" style="border-left-color: #F44336;">
                        <div class="value" style="color: #F44336;">
                            <div><span id="buySmallOrders">-</span></div>
                            <div style="font-size: 0.8em; margin-top: 5px;"><span id="buySmallAmount">-</span>ä¸‡å…ƒ</div>
                        </div>
                        <div class="label">ä¹°å…¥å°å•</div>
                    </div>
                </div>
                
                <h4><i class="fas fa-arrow-down" style="color: #4CAF50;"></i> å–å‡ºæ±‡æ€»</h4>
                <div class="summary-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="summary-item" style="border-left-color: #4CAF50;">
                        <div class="value" style="color: #4CAF50;">
                            <div><span id="sellSuperOrders">-</span></div>
                            <div style="font-size: 0.8em; margin-top: 5px;"><span id="sellSuperAmount">-</span>ä¸‡å…ƒ</div>
                        </div>
                        <div class="label">å–å‡ºç‰¹å¤§å•</div>
                    </div>
                    <div class="summary-item" style="border-left-color: #4CAF50;">
                        <div class="value" style="color: #4CAF50;">
                            <div><span id="sellLargeOrders">-</span></div>
                            <div style="font-size: 0.8em; margin-top: 5px;"><span id="sellLargeAmount">-</span>ä¸‡å…ƒ</div>
                        </div>
                        <div class="label">å–å‡ºå¤§å•</div>
                    </div>
                    <div class="summary-item" style="border-left-color: #4CAF50;">
                        <div class="value" style="color: #4CAF50;">
                            <div><span id="sellMediumOrders">-</span></div>
                            <div style="font-size: 0.8em; margin-top: 5px;"><span id="sellMediumAmount">-</span>ä¸‡å…ƒ</div>
                        </div>
                        <div class="label">å–å‡ºä¸­å•</div>
                    </div>
                    <div class="summary-item" style="border-left-color: #4CAF50;">
                        <div class="value" style="color: #4CAF50;">
                            <div><span id="sellSmallOrders">-</span></div>
                            <div style="font-size: 0.8em; margin-top: 5px;"><span id="sellSmallAmount">-</span>ä¸‡å…ƒ</div>
                        </div>
                        <div class="label">å–å‡ºå°å•</div>
                    </div>
                </div>
            </div>
            
            <div class="chart-container" style="margin-bottom: 30px;">
                <h3><i class="fas fa-balance-scale"></i> ä¹°å–é‡‘é¢å¯¹æ¯”å›¾</h3>
                <div id="buySellChart" style="width: 100%; height: 500px; min-height: 500px;"></div>
            </div>
            
            <!-- é‡å¤åˆ†ææ ç›® -->
            <div class="data-table-container" style="margin-bottom: 30px;">
                <h3 style="text-align: center; margin-bottom: 25px; font-size: 1.5rem;"><i class="fas fa-repeat"></i> é‡å¤åˆ†æ - ç›¸åŒæˆäº¤é‡ç»Ÿè®¡</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                    <!-- ä¹°å…¥é‡å¤åˆ†æè¡¨æ ¼ -->
                    <div style="background: linear-gradient(135deg, #ffebee, #fce4ec); border-radius: 15px; padding: 20px; border-left: 5px solid #F44336; box-shadow: 0 4px 15px rgba(244, 67, 54, 0.1);">
                        <h4 style="color: #F44336; margin-bottom: 20px; text-align: center; font-size: 1.2rem; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">
                            <i class="fas fa-arrow-up" style="margin-right: 8px; font-size: 1.1em;"></i> 
                            ä¹°å…¥ç›¸åŒæˆäº¤é‡å‰5å
                        </h4>
                        <table class="data-table" style="margin-top: 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <thead style="background: linear-gradient(135deg, #F44336, #E53935);">
                                <tr>
                                    <th style="color: #F44336; font-weight: bold;">æ’å</th>
                                    <th style="color: #F44336; font-weight: bold;">æˆäº¤é‡(æ‰‹)</th>
                                    <th style="color: #F44336; font-weight: bold;">é‡å¤æ¬¡æ•°</th>
                                    <th style="color: #F44336; font-weight: bold;">å æ¯”</th>
                                </tr>
                            </thead>
                            <tbody id="buyRepeatTable">
                                <tr><td colspan="4" style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ•°æ®</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- å–å‡ºé‡å¤åˆ†æè¡¨æ ¼ -->
                    <div style="background: linear-gradient(135deg, #e8f5e8, #f1f8e9); border-radius: 15px; padding: 20px; border-left: 5px solid #4CAF50; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.1);">
                        <h4 style="color: #4CAF50; margin-bottom: 20px; text-align: center; font-size: 1.2rem; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">
                            <i class="fas fa-arrow-down" style="margin-right: 8px; font-size: 1.1em;"></i> 
                            å–å‡ºç›¸åŒæˆäº¤é‡å‰5å
                        </h4>
                        <table class="data-table" style="margin-top: 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <thead style="background: linear-gradient(135deg, #4CAF50, #43A047);">
                                <tr>
                                    <th style="color: #4CAF50; font-weight: bold;">æ’å</th>
                                    <th style="color: #4CAF50; font-weight: bold;">æˆäº¤é‡(æ‰‹)</th>
                                    <th style="color: #4CAF50; font-weight: bold;">é‡å¤æ¬¡æ•°</th>
                                    <th style="color: #4CAF50; font-weight: bold;">å æ¯”</th>
                                </tr>
                            </thead>
                            <tbody id="sellRepeatTable">
                                <tr><td colspan="4" style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ•°æ®</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="chart-container" style="margin-bottom: 30px; height: 100vh;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3><i class="fas fa-chart-bar"></i> å†å²æˆäº¤é‡/é‡‘é¢å›¾</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label for="dayRange" style="font-weight: bold;">é€‰æ‹©å‘¨æœŸ:</label>
                        <select id="dayRange" onchange="updateVolumeChartRange()" style="padding: 8px 12px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 14px;">
                            <option value="1">1æ—¥</option>
                            <option value="5">5æ—¥</option>
                            <option value="10" selected>10æ—¥</option>
                            <option value="20">20æ—¥</option>
                            <option value="30">30æ—¥</option>
                            <option value="60">60æ—¥</option>
                            <option value="90">90æ—¥</option>
                        </select>
                        <label for="chartType" style="font-weight: bold;">æ˜¾ç¤ºç±»å‹:</label>
                        <select id="chartType" onchange="updateVolumeChartType()" style="padding: 8px 12px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 14px;">
                            <option value="volume">æˆäº¤é‡</option>
                            <option value="amount">æˆäº¤é‡‘é¢</option>
                        </select>
                    </div>
                </div>
                
                
                <div id="volumeChart" style="width: 100%; height: calc(100% - 120px);"></div>
            </div>
        </div>
    </div>

    <!-- é£é™©è­¦å‘Š -->
    <div class="risk-warning">
        <strong>é£é™©æç¤ºï¼š</strong>æœ¬é¡µé¢åˆ†ç¬”æ•°æ®ä»…ä¾›å‚è€ƒï¼Œä¸åšä¸ºæŠ•èµ„æ¨èåŠå»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ã€‚<br>
        è‚¡ç¥¨æŠ•èµ„å­˜åœ¨ä»·æ ¼æ³¢åŠ¨é£é™©ï¼Œåˆ†ç¬”æ•°æ®åˆ†æä¸èƒ½é¢„æµ‹æœªæ¥èµ°åŠ¿ï¼Œè¯·æ ¹æ®è‡ªèº«é£é™©æ‰¿å—èƒ½åŠ›è°¨æ…æŠ•èµ„ã€‚
    </div>

    <!-- GitHubé“¾æ¥ -->
    <div style="text-align: center; margin: 30px auto; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 15px;">
        <p style="color: #b0c4de; margin-bottom: 10px;">å¼€æºé¡¹ç›®</p>
        <a href="https://github.com/hengruiyun" target="_blank" style="color: #4CAF50; text-decoration: none; font-weight: bold; font-size: 16px;">
            <i class="fab fa-github"></i> è®¿é—®GitHub @hengruiyun
        </a>
    </div>

    <script>
        // è‡ªå®šä¹‰å›¾è¡¨ç±»
        class CustomChart {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.svg = null;
                this.width = 0;
                this.height = 0;
            }

            destroy() {
                if (this.svg) {
                    this.svg.remove();
                    this.svg = null;
                }
            }

            init() {
                this.destroy();
                this.width = this.container.clientWidth || 800;
                this.height = this.container.clientHeight || 400;
                
                console.log('ğŸ¨ SVG åˆå§‹åŒ–:', { width: this.width, height: this.height, container: this.container });
                
                this.svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                this.svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                this.svg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
                this.svg.setAttribute('width', '100%');
                this.svg.setAttribute('height', '100%');
                this.svg.setAttribute('viewBox', `0 0 ${this.width} ${this.height}`);
                this.svg.setAttribute('preserveAspectRatio', 'xMinYMin meet');
                this.svg.style.border = '1px solid #ddd'; // ä¸´æ—¶è¾¹æ¡†ï¼Œä¾¿äºè°ƒè¯•
                this.svg.style.backgroundColor = '#f9f9f9'; // æŸäº›ç¯å¢ƒä¸‹éœ€ä½¿ç”¨ background-color
                this.container.appendChild(this.svg);
                
                console.log('âœ… SVG åˆ›å»ºå®Œæˆ:', this.svg);
                
                return this;
            }

            drawBarChart(data, options = {}) {
                console.log('ğŸ¨ CustomChart.drawBarChart å¼€å§‹ç»˜åˆ¶:', data);
                console.log('ğŸ“ å®¹å™¨å°ºå¯¸:', { width: this.width, height: this.height });
                
                const margin = { top: 20, right: 30, bottom: 60, left: 80 };
                const chartWidth = this.width - margin.left - margin.right;
                const chartHeight = this.height - margin.top - margin.bottom;

                console.log('ğŸ“Š è®¡ç®—åçš„å›¾è¡¨å°ºå¯¸:', { chartWidth, chartHeight });

                // æ¸…ç©ºSVG
                this.svg.innerHTML = '';

                if (!data || !data.datasets || data.datasets.length === 0) {
                    console.error('ğŸš« æ•°æ®æ— æ•ˆæˆ–ä¸ºç©º:', data);
                    return;
                }

                // åˆ›å»ºå›¾è¡¨ç»„
                const chartGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                chartGroup.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);
                this.svg.appendChild(chartGroup);

                const labels = data.labels || [];
                const datasets = data.datasets;
                
                // è®¡ç®—æ•°æ®èŒƒå›´ï¼Œæ·»åŠ æ•°æ®éªŒè¯
                const allValues = datasets.flatMap(d => d.data || []);
                const validValues = allValues.filter(v => !isNaN(v) && isFinite(v));
                const maxValue = validValues.length > 0 ? Math.max(...validValues.map(v => Math.abs(v))) : 1;
                
                const barWidth = chartWidth / labels.length * 0.8;
                const barSpacing = chartWidth / labels.length * 0.2;
                
                // å¦‚æœæ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
                if (validValues.length === 0) {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', chartWidth / 2);
                    text.setAttribute('y', chartHeight / 2);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('font-size', '16');
                    text.setAttribute('fill', '#999');
                    text.textContent = 'æš‚æ— æ•°æ®';
                    chartGroup.appendChild(text);
                    return;
                }

                // ç»˜åˆ¶Yè½´ç½‘æ ¼çº¿å’Œæ ‡ç­¾
                const gridLines = 5;
                for (let i = 0; i <= gridLines; i++) {
                    const y = (chartHeight / gridLines) * i;
                    const value = maxValue - (maxValue / gridLines) * i;
                    
                    // ç½‘æ ¼çº¿
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', 0);
                    line.setAttribute('y1', y);
                    line.setAttribute('x2', chartWidth);
                    line.setAttribute('y2', y);
                    line.setAttribute('stroke', '#e0e0e0');
                    line.setAttribute('stroke-width', 1);
                    chartGroup.appendChild(line);

                    // Yè½´æ ‡ç­¾
                    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    label.setAttribute('x', -10);
                    label.setAttribute('y', y + 5);
                    label.setAttribute('text-anchor', 'end');
                    label.setAttribute('font-size', '12');
                    label.setAttribute('fill', '#666');
                    label.textContent = value.toFixed(0);
                    chartGroup.appendChild(label);
                }

                // ç»˜åˆ¶æŸ±å­
                console.log('ğŸ¯ å¼€å§‹ç»˜åˆ¶æŸ±å­:', { labels, datasets, barWidth, barSpacing, maxValue });
                
                labels.forEach((label, i) => {
                    const x = i * (barWidth + barSpacing);
                    
                    datasets.forEach((dataset, datasetIndex) => {
                        const value = dataset.data[i] || 0;
                        
                        console.log(`ğŸ“Š ç»˜åˆ¶æŸ±å­ [${i}][${datasetIndex}]:`, { label, value, dataset: dataset.label });
                        
                        // ç¡®ä¿æ•°å€¼æœ‰æ•ˆ
                        if (isNaN(value) || !isFinite(value)) {
                            console.warn(`âš ï¸ æ— æ•ˆæ•°å€¼è·³è¿‡: ${value}`);
                            return;
                        }
                        
                        const barHeight = (Math.abs(value) / maxValue) * chartHeight;
                        const y = chartHeight - barHeight;
                        
                        console.log(`ğŸ“ æŸ±å­è®¡ç®—:`, { value, maxValue, barHeight, y, chartHeight });
                        
                        // ç¡®ä¿è®¡ç®—ç»“æœæœ‰æ•ˆ
                        if (isNaN(barHeight) || isNaN(y) || !isFinite(barHeight) || !isFinite(y)) {
                            console.warn(`âš ï¸ è®¡ç®—ç»“æœæ— æ•ˆè·³è¿‡:`, { barHeight, y });
                            return;
                        }
                        
                        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        rect.setAttribute('x', x + (datasetIndex * barWidth / datasets.length));
                        rect.setAttribute('y', y);
                        rect.setAttribute('width', barWidth / datasets.length);
                        rect.setAttribute('height', barHeight);
                        
                        // æ”¯æŒæ¯ä¸ªæŸ±å­ä¸åŒçš„é¢œè‰²
                        let fillColor = dataset.backgroundColor || '#4ecdc4';
                        if (Array.isArray(dataset.backgroundColor) && dataset.backgroundColor[i]) {
                            fillColor = dataset.backgroundColor[i];
                        }
                        
                        // å…¼å®¹éƒ¨åˆ†ç¯å¢ƒä¸‹ SVG å¯¹ rgba() æ”¯æŒä¸å®Œæ•´çš„é—®é¢˜
                        if (typeof fillColor === 'string' && fillColor.startsWith('rgba')) {
                            const match = fillColor.match(/rgba\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*([0-9]*\.?[0-9]+)\)/);
                            if (match) {
                                const r = match[1];
                                const g = match[2];
                                const b = match[3];
                                const a = match[4];
                                rect.setAttribute('fill', `rgb(${r}, ${g}, ${b})`);
                                rect.setAttribute('fill-opacity', a);
                            } else {
                                rect.setAttribute('fill', '#4ecdc4');
                                rect.setAttribute('fill-opacity', '0.8');
                            }
                        } else {
                            rect.setAttribute('fill', fillColor);
                            rect.setAttribute('fill-opacity', '0.8');
                        }
                        chartGroup.appendChild(rect);
                        
                        console.log(`âœ… æŸ±å­åˆ›å»ºæˆåŠŸ:`, { 
                            x: x + (datasetIndex * barWidth / datasets.length), 
                            y, 
                            width: barWidth / datasets.length, 
                            height: barHeight, 
                            color: fillColor 
                        });
                    });

                    // Xè½´æ ‡ç­¾
                    const labelElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    labelElement.setAttribute('x', x + barWidth / 2);
                    labelElement.setAttribute('y', chartHeight + 20);
                    labelElement.setAttribute('text-anchor', 'middle');
                    labelElement.setAttribute('font-size', '12');
                    labelElement.setAttribute('fill', '#666');
                    labelElement.textContent = label;
                    chartGroup.appendChild(labelElement);
                });
                
                // ç»˜åˆ¶åæ ‡è½´
                const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                xAxis.setAttribute('x1', 0);
                xAxis.setAttribute('y1', chartHeight);
                xAxis.setAttribute('x2', chartWidth);
                xAxis.setAttribute('y2', chartHeight);
                xAxis.setAttribute('stroke', '#333');
                xAxis.setAttribute('stroke-width', 2);
                chartGroup.appendChild(xAxis);
                
                const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                yAxis.setAttribute('x1', 0);
                yAxis.setAttribute('y1', 0);
                yAxis.setAttribute('x2', 0);
                yAxis.setAttribute('y2', chartHeight);
                yAxis.setAttribute('stroke', '#333');
                yAxis.setAttribute('stroke-width', 2);
                chartGroup.appendChild(yAxis);
                
                console.log('âœ… å›¾è¡¨ç»˜åˆ¶å®Œæˆï¼ŒåŒ…å«åæ ‡è½´');
            }
        }

        let currentData = [];
        let analyzedData = [];
        let buySellChart = null;
        let volumeChart = null;
        let currentStockCode = '';
        let currentVolumeData = [];
        let currentStockName = '';
        let isAnalyzing = false; // é˜²æ­¢é‡å¤åˆ†æ
        
        // å…¨å±€å˜é‡ä¿å­˜å½“å‰åˆ†æçš„è‚¡ç¥¨ä¿¡æ¯
        let globalCurrentStockCode = '';
        let globalCurrentStockName = '';

        // ç»Ÿä¸€çš„æœåŠ¡å™¨åœ°å€è·å–å‡½æ•°
        function getServerUrl() {
            const protocol = window.location.protocol;
            
            // å¦‚æœæ˜¯é€šè¿‡HTTP/HTTPSè®¿é—®ï¼ˆä»æœåŠ¡å™¨åŠ è½½çš„ï¼‰ï¼Œç›´æ¥ä½¿ç”¨å½“å‰åœ°å€çš„åŸŸåå’Œç«¯å£
            if (protocol === 'http:' || protocol === 'https:') {
                return window.location.origin;
            }
            
            // å¦‚æœæ˜¯fileåè®®ï¼Œå›é€€åˆ°localhost:16888
            return 'http://localhost:16888';
        }
        
        const SERVER_URL = getServerUrl();

        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºæœ€æ–°äº¤æ˜“æ—¥
        setDefaultTradeDate();

        // URLå‚æ•°è§£æå‡½æ•°
        function getUrlParams() {
            const params = {};
            
            // é¦–å…ˆå°è¯•è§£ææ ‡å‡†URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            for (const [key, value] of urlParams) {
                params[key] = value;
            }
            
            // ç„¶åå°è¯•è§£æ##æ ¼å¼çš„å‚æ•° (æ”¯æŒæ ¼å¼: ##ä»£ç ##åç§°##ã€##ä»£ç ##ã€##ä»£ç )
            const hash = window.location.hash;
            if (hash) {
                // ç§»é™¤å¼€å¤´çš„#ç¬¦å·
                let hashContent = hash;
                while (hashContent.startsWith('#')) {
                    hashContent = hashContent.substring(1);
                }
                
                // URLè§£ç ï¼ˆå¤„ç†%23ç­‰ç¼–ç å­—ç¬¦ï¼‰
                console.log('è§£ç å‰çš„hashContent:', hashContent);
                try {
                    hashContent = decodeURIComponent(hashContent);
                    console.log('è§£ç åçš„hashContent:', hashContent);
                } catch (e) {
                    console.error('URLè§£ç å¤±è´¥:', e);
                }
                
                // è§£ç åå¯èƒ½è¿˜æœ‰å‰å¯¼#ï¼Œå†æ¬¡ç§»é™¤
                while (hashContent.startsWith('#')) {
                    hashContent = hashContent.substring(1);
                }
                console.log('ç§»é™¤å‰å¯¼#åçš„hashContent:', hashContent);
                
                if (hashContent) {
                    // æŒ‰##åˆ†å‰²
                    const parts = hashContent.split('##');
                    
                    if (parts.length >= 1 && parts[0]) {
                        const code = parts[0].trim();
                        // éªŒè¯æ˜¯å¦ä¸º6ä½æ•°å­—çš„è‚¡ç¥¨ä»£ç 
                        if (/^\d{6}$/.test(code)) {
                            params.code = code;
                            // å¦‚æœæœ‰ç¬¬äºŒéƒ¨åˆ†ï¼Œä½¿ç”¨å®ƒä½œä¸ºåç§°ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
                            if (parts.length >= 2) {
                                params.name = decodeURIComponent(parts[1] || '');
                            }
                            console.log(`ä»URL hashè§£æå‚æ•°: ä»£ç =${params.code}, åç§°=${params.name || '(æœªæä¾›)'}`);
                        }
                    }
                }
            }
            
            return params;
        }

        // è·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
        async function fetchStockBasic(code) {
            try {
                // æ·»åŠ å¤šé‡å‚æ•°é¿å…ç¼“å­˜
                const timestamp = new Date().getTime();
                const randomId = Math.random().toString(36).substring(2, 15);
                const cacheBreaker = `${timestamp}_${randomId}`;
                const response = await fetch(`${SERVER_URL}/api/stock/basic?source=akshare&_t=${cacheBreaker}&nocache=1`, {
                    cache: 'no-cache'
                });
                if (!response.ok) throw new Error('è·å–åŸºæœ¬ä¿¡æ¯å¤±è´¥');
                
                const data = await response.json();
                if (!data.success) throw new Error(data.message || 'è·å–åŸºæœ¬ä¿¡æ¯å¤±è´¥');
                
                const stockInfo = data.data.find(item => item.code === code || item.symbol === code);
                return stockInfo || { code: code, name: code, industry: 'æœªçŸ¥' };
            } catch (error) {
                return { code: code, name: code, industry: 'æœªçŸ¥' };
            }
        }

        // æ£€æŸ¥URLå‚æ•°å¹¶è‡ªåŠ¨åˆ†æ
        async function checkUrlParams() {
            const params = getUrlParams();
            
            if (params.code && /^\d{6}$/.test(params.code)) {
                // å¦‚æœæœ‰æœ‰æ•ˆçš„URLå‚æ•°ï¼Œè‡ªåŠ¨è®¾ç½®è‚¡ç¥¨ä»£ç å¹¶åˆ†æ
                document.getElementById('stockCode').value = params.code;
                // ä¿å­˜åˆ°å…¨å±€å˜é‡
                globalCurrentStockCode = params.code;
                
                // è·å–è‚¡ç¥¨åç§°
                if (params.name) {
                    currentStockName = params.name;
                    globalCurrentStockName = params.name;
                } else {
                    const stockInfo = await fetchStockBasic(params.code);
                    currentStockName = stockInfo.name;
                    globalCurrentStockName = stockInfo.name;
                }
                
                // ç¡®ä¿æ—¥æœŸå·²è®¾ç½®ï¼Œç„¶åå»¶è¿Ÿåˆ†æ
                await setDefaultTradeDate();
                setTimeout(() => {
                    analyzeStock();
                }, 1000);
            } else {
                // æ²¡æœ‰æœ‰æ•ˆå‚æ•°ï¼Œä¿æŒè¾“å…¥æ¡†ä¸ºç©º
                document.getElementById('stockCode').value = '';
                }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥URLå‚æ•°
        checkUrlParams();

        async function setDefaultTradeDate() {
            try {
                // ä½¿ç”¨æœåŠ¡å™¨çš„"å½“å¤©"å‡½æ•°è·å–äº¤æ˜“æ—¥æœŸ
                const response = await fetch(`${SERVER_URL}/api/current_trading_date`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data && result.data.date) {
                        document.getElementById('tradeDate').value = result.data.date;
                        return;
                    }
                } else if (response.status === 404) {
                    }
                
                // é™çº§å¤„ç†ï¼šä½¿ç”¨æœ¬åœ°é€»è¾‘
                const now = new Date();
                const hour = now.getHours();
                
                // 17:00ä¹‹å‰ä½¿ç”¨æ˜¨å¤©ï¼Œ17:00ä¹‹åä½¿ç”¨å½“å¤©
                let targetDate = new Date(now);
                if (hour < 17) {
                    targetDate.setDate(now.getDate() - 1);
                }
                
                const dateString = targetDate.toISOString().split('T')[0];
                document.getElementById('tradeDate').value = dateString;
                } catch (error) {
                // æœ€ç»ˆé™çº§å¤„ç†ï¼Œä½¿ç”¨ä»Šå¤©
                document.getElementById('tradeDate').value = new Date().toISOString().split('T')[0];
            }
        }

        // æ¸…é™¤ç¼“å­˜å’Œé‡ç½®æ•°æ®
        function clearCacheAndReset() {
            
            // æ¸…é™¤å…¨å±€å˜é‡
            currentData = [];
            analyzedData = [];
            currentStockCode = '';
            currentStockName = '';
            currentVolumeData = [];
            
            // æ¸…é™¤å›¾è¡¨æ•°æ®ç¼“å­˜
            if (window.chartAmountData) {
                delete window.chartAmountData;
            }
            
            // é”€æ¯ç°æœ‰å›¾è¡¨
            if (buySellChart) {
                buySellChart.destroy();
                buySellChart = null;
            }
            if (volumeChart) {
                volumeChart.destroy();
                volumeChart = null;
            }
            
            // é‡ç½®æ˜¾ç¤ºå…ƒç´ 
            resetDisplayElements();
            
            // éšè—ç»“æœåŒºåŸŸ
            hideResults();
            hideSuccess();
            hideError();
        }

        // é‡ç½®æ˜¾ç¤ºå…ƒç´ 
        function resetDisplayElements() {
            // é‡ç½®åˆ†ææ±‡æ€»
            document.getElementById('totalTrades').textContent = '-';
            document.getElementById('totalAmount').textContent = '-';
            document.getElementById('avgAmount').textContent = '-';
            document.getElementById('maxAmount').textContent = '-';
            
            // é‡ç½®ä¹°å…¥æ±‡æ€»
            document.getElementById('buySmallOrders').textContent = '-';
            document.getElementById('buyMediumOrders').textContent = '-';
            document.getElementById('buyLargeOrders').textContent = '-';
            document.getElementById('buySuperOrders').textContent = '-';
            document.getElementById('buySmallAmount').textContent = '-';
            document.getElementById('buyMediumAmount').textContent = '-';
            document.getElementById('buyLargeAmount').textContent = '-';
            document.getElementById('buySuperAmount').textContent = '-';
            
            // é‡ç½®å–å‡ºæ±‡æ€»
            document.getElementById('sellSmallOrders').textContent = '-';
            document.getElementById('sellMediumOrders').textContent = '-';
            document.getElementById('sellLargeOrders').textContent = '-';
            document.getElementById('sellSuperOrders').textContent = '-';
            document.getElementById('sellSmallAmount').textContent = '-';
            document.getElementById('sellMediumAmount').textContent = '-';
            document.getElementById('sellLargeAmount').textContent = '-';
            document.getElementById('sellSuperAmount').textContent = '-';
            
            // é‡ç½®é‡å¤åˆ†æè¡¨æ ¼
            document.getElementById('buyRepeatTable').innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">æš‚æ— æ•°æ®</td></tr>';
            document.getElementById('sellRepeatTable').innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">æš‚æ— æ•°æ®</td></tr>';
        }

        // æ‰“å¼€å¤šç©ºåˆ†æé¡µé¢
        function openBattleAnalysis() {
            // ä¼˜å…ˆå–ä»£ç è¾“å…¥æ¡†çš„å€¼ï¼Œå¦‚æœä¸ºç©ºåˆ™å–å…¨å±€å˜é‡
            let code = document.getElementById('stockCode').value.trim();
            let name = '';
            
            if (!code) {
                code = globalCurrentStockCode || '';
                name = globalCurrentStockName || '';
            }
            
            if (code && /^\d{6}$/.test(code)) {
                // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œå…¼å®¹file://åè®®
                const url = `å¤šç©ºåšå¼ˆå¤§å¸ˆç‰ˆ.html##${code}##${encodeURIComponent(name)}##`;
                window.location.href = url;
            } else {
                alert('è¯·å…ˆè¾“å…¥æˆ–åˆ†æè‚¡ç¥¨ä»£ç ');
            }
        }

        // é€šè¾¾ä¿¡å¹¿æ’­åŠŸèƒ½ - é€šç”¨å‡½æ•°
        async function broadcastToTdx(stockCode) {
            try {
                console.log('æ­£åœ¨å¹¿æ’­è‚¡ç¥¨ä»£ç åˆ°é€šè¾¾ä¿¡:', stockCode);
                const serverUrl = getServerUrl();
                console.log('ä½¿ç”¨æœåŠ¡å™¨åœ°å€:', serverUrl);
                
                const response = await fetch(`${serverUrl}/api/broadcast`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stock_code: stockCode
                    })
                });
                
                console.log('å¹¿æ’­å“åº”çŠ¶æ€:', response.status);
                const result = await response.json();
                console.log('å¹¿æ’­å“åº”ç»“æœ:', result);
                
                if (result.success) {
                    console.log('âœ“ æˆåŠŸå¹¿æ’­è‚¡ç¥¨ä»£ç åˆ°é€šè¾¾ä¿¡:', stockCode);
                } else {
                    console.warn('âœ— å¹¿æ’­è‚¡ç¥¨ä»£ç åˆ°é€šè¾¾ä¿¡å¤±è´¥:', result.error);
                }
            } catch (error) {
                console.error('âœ— å¹¿æ’­è‚¡ç¥¨ä»£ç åˆ°é€šè¾¾ä¿¡æ—¶å‘ç”Ÿé”™è¯¯:', error);
            }
        }
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                max-width: 300px;
                word-wrap: break-word;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
        
        async function analyzeStock() {
            // é˜²æ­¢é‡å¤åˆ†æ
            if (isAnalyzing) {
                return;
            }
            
            // æ¸…é™¤ç¼“å­˜æ•°æ®ï¼Œé‡æ–°è·å–è‚¡ç¥¨ä¿¡æ¯
            clearCacheAndReset();
            
            const stockCode = document.getElementById('stockCode').value.trim();
            window.currentAnalyzedCode = stockCode; // ä¿å­˜åˆ°å…¨å±€å˜é‡ä¾›å¤šç©ºåˆ†ææŒ‰é’®ä½¿ç”¨
            
            // å¹¿æ’­åˆ°é€šè¾¾ä¿¡
            broadcastToTdx(stockCode);
            const tradeDate = document.getElementById('tradeDate').value;
            
            if (!stockCode) {
                showError('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            if (!tradeDate) {
                showError('è¯·é€‰æ‹©äº¤æ˜“æ—¥æœŸ');
                return;
            }

            // éªŒè¯è®¢å•ä¸Šé™è®¾ç½®å¹¶è‡ªåŠ¨è®¾ç½®ç‰¹å¤§å•ä¸‹é™
            const smallLimit = parseFloat(document.getElementById('smallThreshold').value);
            const mediumLimit = parseFloat(document.getElementById('mediumThreshold').value);
            const largeLimit = parseFloat(document.getElementById('largeThreshold').value);
            
            // è‡ªåŠ¨è®¾ç½®ç‰¹å¤§å•ä¸‹é™ä¸ºå¤§å•ä¸Šé™
            const superLimit = largeLimit;
            document.getElementById('superThreshold').value = superLimit;
            
            if (!(smallLimit < mediumLimit && mediumLimit < largeLimit)) {
                showError('è®¢å•ä¸Šé™è®¾ç½®é”™è¯¯ï¼šå¿…é¡»æ»¡è¶³ å°å•ä¸Šé™ < ä¸­å•ä¸Šé™ < å¤§å•ä¸Šé™');
                return;
            }

            isAnalyzing = true; // è®¾ç½®åˆ†æçŠ¶æ€
            
            // éšè—ç»“æœå’Œé”™è¯¯ä¿¡æ¯ï¼Œæ˜¾ç¤ºè¿›åº¦æ¡
            hideResults();
            hideError();
            hideSuccess();
            showProgress(true);
            
            try {
                // æ­¥éª¤1: è·å–åˆ†ç¬”æ•°æ®
                updateProgress(1, 20, 'æ­£åœ¨è·å–åˆ†ç¬”æ•°æ®...');
                await new Promise(resolve => setTimeout(resolve, 500)); // çŸ­æš‚å»¶è¿Ÿè®©ç”¨æˆ·çœ‹åˆ°è¿›åº¦
                
                // æ·»åŠ å¤šé‡å‚æ•°é¿å…ç¼“å­˜
                const timestamp = new Date().getTime();
                const randomId = Math.random().toString(36).substring(2, 15);
                const cacheBreaker = `${timestamp}_${randomId}`;
                const apiUrl = `${SERVER_URL}/api/stock/tick_analysis?code=${stockCode}&date=${tradeDate.replace(/-/g, '')}&_t=${cacheBreaker}&nocache=1`;
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    cache: 'no-cache'
                });
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}`);
                }

                if (result.success) {
                    currentData = result.data.tick_data || [];
                    currentStockCode = stockCode;
                    
                    // æ£€æŸ¥æ—¥æœŸæ˜¯å¦åŒ¹é… - åªåœ¨è·å–åˆ°å½“å¤©æ•°æ®ä½†è¯·æ±‚å†å²æ•°æ®æ—¶æç¤º
                    if (result.data.requested_date && result.data.actual_date && 
                        result.data.requested_date !== result.data.actual_date) {
                        const requestedDate = result.data.requested_date;
                        const actualDate = result.data.actual_date;
                        
                        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                        const formatDate = (dateStr) => {
                            if (dateStr.length === 8) {
                                return dateStr.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
                            }
                            return dateStr;
                        };
                        
                        // æ£€æŸ¥æ•°æ®æºï¼Œå¦‚æœæ˜¯å†å²æ•°æ®æºåˆ™ä¸æ˜¾ç¤ºè­¦å‘Š
                        const dataSource = result.data.data_source || '';
                        const isHistoricalData = dataSource.includes('å†å²æ•°æ®') || dataSource.includes('æ–°æµª');
                        
                        if (!isHistoricalData) {
                            // åªæœ‰åœ¨æ²¡æœ‰è·å–åˆ°å†å²æ•°æ®æ—¶æ‰æ˜¾ç¤ºè­¦å‘Š
                            showError(`ğŸ“… æ—¥æœŸæç¤ºï¼šè¯·æ±‚çš„æ—¥æœŸæ˜¯ ${formatDate(requestedDate)}ï¼Œä½†è·å–åˆ°çš„æ˜¯å½“å¤©æ•°æ® ${formatDate(actualDate)}\n\n` +
                                     `ğŸ’¡ è¯´æ˜ï¼šè¯¥æ—¥æœŸå¯èƒ½æ— åˆ†ç¬”æ•°æ®æˆ–éäº¤æ˜“æ—¥ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°æœ€è¿‘äº¤æ˜“æ—¥æ•°æ®`);
                            
                            // æ›´æ–°æ—¥æœŸè¾“å…¥æ¡†ä¸ºå®é™…æ•°æ®æ—¥æœŸ
                            if (actualDate && actualDate.length === 8) {
                                const formattedDate = actualDate.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
                                document.getElementById('tradeDate').value = formattedDate;
                            }
                        } else {
                            // å¦‚æœæ˜¯å†å²æ•°æ®ï¼Œæ˜¾ç¤ºæˆåŠŸè·å–çš„æç¤º
                            showSuccess(`âœ… æˆåŠŸè·å– ${formatDate(requestedDate)} çš„å†å²åˆ†ç¬”æ•°æ® (æ•°æ®æº: ${dataSource})`);
                        }
                    }
                    
                    // ä¿å­˜åˆ°å…¨å±€å˜é‡
                    globalCurrentStockCode = stockCode;
                    
                    // æ­¥éª¤2: è·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ï¼ˆæ¯æ¬¡éƒ½é‡æ–°è·å–ï¼‰
                    updateProgress(2, 40, 'æ­£åœ¨è·å–è‚¡ç¥¨ä¿¡æ¯...');
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    // å¼ºåˆ¶é‡æ–°è·å–è‚¡ç¥¨åç§°ï¼Œä¸ä½¿ç”¨ç¼“å­˜
                    const stockInfo = await fetchStockBasic(stockCode);
                    currentStockName = stockInfo.name;
                    globalCurrentStockName = stockInfo.name;
                    
                    // æ­¥éª¤3: åˆ†æä¹°å–æ–¹å‘å’Œç»Ÿè®¡è®¢å•
                    updateProgress(3, 60, 'æ­£åœ¨åˆ†æä¹°å–æ–¹å‘å’Œè®¢å•åˆ†ç±»...');
                    await new Promise(resolve => setTimeout(resolve, 400));
                    analyzeTickData();
                    
                    // æ­¥éª¤4: è·å–å†å²æˆäº¤é‡æ•°æ®
                    updateProgress(4, 80, 'æ­£åœ¨è·å–å†å²æˆäº¤é‡æ•°æ®...');
                    await new Promise(resolve => setTimeout(resolve, 300));
                    await loadVolumeData(stockCode, 10);
                    
                    // æ­¥éª¤5: ç”Ÿæˆå›¾è¡¨
                    updateProgress(5, 100, 'æ­£åœ¨ç”Ÿæˆå›¾è¡¨...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // åˆ†æå®Œæˆï¼Œæ˜¾ç¤ºç»“æœ
                    showProgress(false);
                    showSuccess(`æˆåŠŸåˆ†æ ${currentStockName} (${stockCode}) çš„ ${currentData.length} æ¡åˆ†ç¬”æ•°æ®`);
                    showResults();
                    isAnalyzing = false; // é‡ç½®åˆ†æçŠ¶æ€
                } else {
                    // å¤„ç†ç‰¹æ®Šçš„å†å²æ•°æ®é”™è¯¯
                    if (result.is_historical_request && result.data_limitation) {
                        const errorMsg = result.error || 'è·å–å†å²åˆ†ç¬”æ•°æ®å¤±è´¥';
                        // æ£€æŸ¥æ˜¯å¦æ”¯æŒå†å²æ•°æ®
                        if (result.data_limitation.includes('å·²æ”¯æŒ')) {
                            throw new Error(`${errorMsg}\n\nğŸ’¡ ${result.data_limitation}`);
                        } else {
                            throw new Error(`${errorMsg}\n\nğŸ’¡ ${result.data_limitation}`);
                        }
                    } else {
                        throw new Error(result.error || 'è·å–æ•°æ®å¤±è´¥');
                    }
                }
            } catch (error) {
                showProgress(false);
                showError(error.message || 'é”™è¯¯ï¼Œæ£€æŸ¥ç½‘ç»œè¿æ¥å’Œå¤§å¸ˆæœåŠ¡å™¨çŠ¶æ€');
                isAnalyzing = false; // é‡ç½®åˆ†æçŠ¶æ€
            }
        }

        function analyzeTickData() {
            if (currentData.length === 0) {
                showError('æ²¡æœ‰æ•°æ®å¯åˆ†æ');
                return;
            }

            const smallThreshold = parseFloat(document.getElementById('smallThreshold').value) * 10000;
            const mediumThreshold = parseFloat(document.getElementById('mediumThreshold').value) * 10000;
            const largeThreshold = parseFloat(document.getElementById('largeThreshold').value) * 10000;
            // ç‰¹å¤§å•ä¸‹é™å°±æ˜¯å¤§å•ä¸Šé™
            const superThreshold = largeThreshold;

            analyzedData = currentData.map(item => {
                const amount = parseFloat(item.amount || 0);
                let orderType = 'small';
                let orderLabel = 'å°å•';

                if (amount <= smallThreshold) {
                    orderType = 'small';
                    orderLabel = 'å°å•';
                } else if (amount <= mediumThreshold) {
                    orderType = 'medium';
                    orderLabel = 'ä¸­å•';
                } else if (amount <= largeThreshold) {
                    orderType = 'large';
                    orderLabel = 'å¤§å•';
                } else {
                    // å¤§äºå¤§å•ä¸Šé™çš„éƒ½æ˜¯ç‰¹å¤§å•
                    orderType = 'super';
                    orderLabel = 'ç‰¹å¤§å•';
                }

                return {
                    ...item,
                    orderType,
                    orderLabel,
                    amountWan: (amount / 10000).toFixed(2)
                };
            });

            updateSummary();
            updateChart();
        }

        // è·å–è‚¡ç¥¨è¡Œæƒ…æ•°æ® - æ ¹æ®æŒ‡å®šå¤©æ•°è®¡ç®—æ—¥æœŸèŒƒå›´
        async function getStockMarketData(stockCode, days) {
            try {
                // è®¡ç®—æ—¥æœŸèŒƒå›´ï¼šä¸ºäº†ç¡®ä¿è·å¾—è¶³å¤Ÿçš„äº¤æ˜“æ—¥æ•°æ®ï¼Œå¤šå–ä¸€äº›å¤©æ•°
                const endDate = new Date();
                const startDate = new Date();
                
                // æ ¹æ®å¤©æ•°è®¡ç®—å¼€å§‹æ—¥æœŸï¼Œè€ƒè™‘å‘¨æœ«å’ŒèŠ‚å‡æ—¥ï¼Œå¤šå–ä¸€äº›å¤©æ•°
                const extraDays = Math.ceil(days * 1.5); // å¤šå–50%çš„å¤©æ•°ç¡®ä¿æœ‰è¶³å¤Ÿçš„äº¤æ˜“æ—¥
                startDate.setDate(endDate.getDate() - extraDays);
                
                const startDateStr = startDate.toISOString().split('T')[0];
                const endDateStr = endDate.toISOString().split('T')[0];
                
                const timestamp = new Date().getTime();
                const randomId = Math.random().toString(36).substring(2, 15);
                const cacheBreaker = `${timestamp}_${randomId}`;
                
                const params = new URLSearchParams({
                    code: stockCode,
                    source: 'akshare',
                    start_date: startDateStr,
                    end_date: endDateStr,
                    _t: cacheBreaker,
                    nocache: '1'
                });
                
                const response = await fetch(`${SERVER_URL}/api/stock/market?${params}`, {
                    cache: 'no-cache'
                });
                if (response.ok) {
                    const data = await response.json();
                    return data;
                } else {
                    return null;
                }
            } catch (error) {
                return null;
            }
        }

        async function loadVolumeData(stockCode, days) {
            try {
                const data = await getStockMarketData(stockCode, days);
                
                if (data && data.success && data.data) {
                    const marketData = data.data || [];
                    // ç¡®ä¿æ•°æ®æŒ‰æ—¥æœŸæ’åºï¼ˆå‡åºï¼‰
                    const sortedData = marketData.sort((a, b) => {
                        const dateA = a.date || a.trading_date || '';
                        const dateB = b.date || b.trading_date || '';
                        return dateA.localeCompare(dateB);
                    });
                    
                    // å–æœ€è¿‘æŒ‡å®šå¤©æ•°çš„äº¤æ˜“æ—¥
                    const recentDays = sortedData.slice(-days);
                    currentVolumeData = recentDays;
                    updateVolumeChart(recentDays);
                } else {
                    currentVolumeData = [];
                    updateVolumeChart([]);
                }
            } catch (error) {
                currentVolumeData = [];
                updateVolumeChart([]);
            }
        }

        async function updateVolumeChartRange() {
            const days = parseInt(document.getElementById('dayRange').value);
            if (currentStockCode) {
                await loadVolumeData(currentStockCode, days);
            }
        }

        function updateVolumeChartType() {
            if (currentVolumeData.length > 0) {
                updateVolumeChart(currentVolumeData);
            }
        }

        function updateSummary() {
            const totalTrades = analyzedData.length;
            const totalAmount = analyzedData.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            const avgAmount = totalAmount / totalTrades;
            const maxAmount = Math.max(...analyzedData.map(item => parseFloat(item.amount || 0)));

            // ä¹°å…¥ç»Ÿè®¡
            const buyData = analyzedData.filter(item => {
                const direction = item.direction || '';
                return direction.includes('ä¹°') || direction.includes('ä¸»ä¹°');
            });
            
            const buySmallOrders = buyData.filter(item => item.orderType === 'small').length;
            const buyMediumOrders = buyData.filter(item => item.orderType === 'medium').length;
            const buyLargeOrders = buyData.filter(item => item.orderType === 'large').length;
            const buySuperOrders = buyData.filter(item => item.orderType === 'super').length;

            // ä¹°å…¥é‡‘é¢ç»Ÿè®¡
            const buySmallAmount = buyData.filter(item => item.orderType === 'small').reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            const buyMediumAmount = buyData.filter(item => item.orderType === 'medium').reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            const buyLargeAmount = buyData.filter(item => item.orderType === 'large').reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            const buySuperAmount = buyData.filter(item => item.orderType === 'super').reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);

            // å–å‡ºç»Ÿè®¡
            const sellData = analyzedData.filter(item => {
                const direction = item.direction || '';
                return !(direction.includes('ä¹°') || direction.includes('ä¸»ä¹°'));
            });
            
            const sellSmallOrders = sellData.filter(item => item.orderType === 'small').length;
            const sellMediumOrders = sellData.filter(item => item.orderType === 'medium').length;
            const sellLargeOrders = sellData.filter(item => item.orderType === 'large').length;
            const sellSuperOrders = sellData.filter(item => item.orderType === 'super').length;

            // å–å‡ºé‡‘é¢ç»Ÿè®¡
            const sellSmallAmount = sellData.filter(item => item.orderType === 'small').reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            const sellMediumAmount = sellData.filter(item => item.orderType === 'medium').reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            const sellLargeAmount = sellData.filter(item => item.orderType === 'large').reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            const sellSuperAmount = sellData.filter(item => item.orderType === 'super').reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);

            // é‡å¤åˆ†æ - æ‰¾å‡ºæœ€å¤šç›¸åŒæˆäº¤é‡çš„æ‰‹æ•°
            const buyRepeatAnalysis = analyzeRepeatVolumeTop5(buyData);
            const sellRepeatAnalysis = analyzeRepeatVolumeTop5(sellData);

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('totalTrades').textContent = totalTrades.toLocaleString();
            document.getElementById('totalAmount').textContent = (totalAmount / 10000).toFixed(2);
            document.getElementById('avgAmount').textContent = (avgAmount / 10000).toFixed(2);
            document.getElementById('maxAmount').textContent = (maxAmount / 10000).toFixed(2);

            // ä¹°å…¥æ±‡æ€» - ç¬”æ•°å’Œé‡‘é¢
            document.getElementById('buySmallOrders').textContent = buySmallOrders.toLocaleString();
            document.getElementById('buyMediumOrders').textContent = buyMediumOrders.toLocaleString();
            document.getElementById('buyLargeOrders').textContent = buyLargeOrders.toLocaleString();
            document.getElementById('buySuperOrders').textContent = buySuperOrders.toLocaleString();

            document.getElementById('buySmallAmount').textContent = (buySmallAmount / 10000).toFixed(1);
            document.getElementById('buyMediumAmount').textContent = (buyMediumAmount / 10000).toFixed(1);
            document.getElementById('buyLargeAmount').textContent = (buyLargeAmount / 10000).toFixed(1);
            document.getElementById('buySuperAmount').textContent = (buySuperAmount / 10000).toFixed(1);

            // å–å‡ºæ±‡æ€» - ç¬”æ•°å’Œé‡‘é¢
            document.getElementById('sellSmallOrders').textContent = sellSmallOrders.toLocaleString();
            document.getElementById('sellMediumOrders').textContent = sellMediumOrders.toLocaleString();
            document.getElementById('sellLargeOrders').textContent = sellLargeOrders.toLocaleString();
            document.getElementById('sellSuperOrders').textContent = sellSuperOrders.toLocaleString();

            document.getElementById('sellSmallAmount').textContent = (sellSmallAmount / 10000).toFixed(1);
            document.getElementById('sellMediumAmount').textContent = (sellMediumAmount / 10000).toFixed(1);
            document.getElementById('sellLargeAmount').textContent = (sellLargeAmount / 10000).toFixed(1);
            document.getElementById('sellSuperAmount').textContent = (sellSuperAmount / 10000).toFixed(1);

            // é‡å¤åˆ†æè¡¨æ ¼æ˜¾ç¤º
            updateRepeatAnalysisTable('buyRepeatTable', buyRepeatAnalysis);
            updateRepeatAnalysisTable('sellRepeatTable', sellRepeatAnalysis);

            // ä¿å­˜é‡‘é¢æ•°æ®ä¾›å›¾è¡¨ä½¿ç”¨
            window.chartAmountData = {
                buy: [buySuperAmount, buyLargeAmount, buyMediumAmount, buySmallAmount],
                sell: [sellSuperAmount, sellLargeAmount, sellMediumAmount, sellSmallAmount]
            };
        }

        // é‡å¤åˆ†æå‡½æ•° - åˆ†æç›¸åŒæˆäº¤é‡çš„æ‰‹æ•°ï¼ˆè¿”å›å‰5åï¼‰
        function analyzeRepeatVolumeTop5(data) {
            if (!data || data.length === 0) {
                return [];
            }
            
            // ç»Ÿè®¡æ¯ä¸ªæˆäº¤é‡çš„å‡ºç°æ¬¡æ•°
            const volumeCount = {};
            data.forEach(item => {
                const volume = parseInt(item.volume || 0);
                if (volume > 0) {
                    volumeCount[volume] = (volumeCount[volume] || 0) + 1;
                }
            });
            
            // å°†ç»Ÿè®¡ç»“æœè½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ¬¡æ•°æ’åºï¼Œå–å‰5åï¼ˆä¸è¦æ±‚>=5ï¼‰
            const sortedVolumes = Object.entries(volumeCount)
                .map(([volume, count]) => ({ volume: parseInt(volume), count: count }))
                .sort((a, b) => b.count - a.count) // æŒ‰æ¬¡æ•°é™åºæ’åº
                .slice(0, 5); // å–å‰5å
            
            // è®¡ç®—å æ¯”
            const totalCount = data.length;
            return sortedVolumes.map(item => ({
                ...item,
                percentage: ((item.count / totalCount) * 100).toFixed(1)
            }));
        }

        // æ›´æ–°é‡å¤åˆ†æè¡¨æ ¼
        function updateRepeatAnalysisTable(tableId, data) {
            const tbody = document.getElementById(tableId);
            const isBuyTable = tableId === 'buyRepeatTable';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ•°æ®</td></tr>';
                return;
            }
            
            let html = '';
            data.forEach((item, index) => {
                // æ ¹æ®ä¹°å…¥/å–å‡ºè¡¨æ ¼ä½¿ç”¨ä¸åŒçš„é¢œè‰²ä¸»é¢˜
                const rowColor = isBuyTable ? 
                    (index % 2 === 0 ? '#fff5f5' : '#ffffff') : 
                    (index % 2 === 0 ? '#f0fff4' : '#ffffff');
                const accentColor = isBuyTable ? '#F44336' : '#4CAF50';
                const lightAccentColor = isBuyTable ? '#ffcdd2' : '#c8e6c9';
                
                html += `
                    <tr style="background-color: ${rowColor}; transition: all 0.3s ease;" 
                        onmouseover="this.style.backgroundColor='${lightAccentColor}'" 
                        onmouseout="this.style.backgroundColor='${rowColor}'">
                        <td style="text-align: center; font-weight: bold; color: ${accentColor}; font-size: 1.1em;">${index + 1}</td>
                        <td style="text-align: center; font-weight: bold;">${item.volume.toLocaleString()}</td>
                        <td style="text-align: center; color: ${accentColor}; font-weight: bold; font-size: 1.1em;">${item.count}</td>
                        <td style="text-align: center; color: ${accentColor}; font-weight: bold; font-size: 1.1em;">${item.percentage}%</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function updateChart() {
            const chartContainer = document.getElementById('buySellChart');
            
            // æ£€æŸ¥å®¹å™¨æ˜¯å¦å¯è§ï¼Œå¦‚æœä¸å¯è§åˆ™å»¶è¿Ÿæ‰§è¡Œ
            if (chartContainer.offsetWidth === 0 || chartContainer.offsetHeight === 0) {
                setTimeout(() => updateChart(), 100);
                return;
            }
            
            if (buySellChart) {
                buySellChart.destroy();
            }
            
            // åˆ›å»ºè‡ªå®šä¹‰å›¾è¡¨
            buySellChart = new CustomChart('buySellChart').init();

            // ä½¿ç”¨é¢„å…ˆè®¡ç®—çš„é‡‘é¢æ•°æ®
            const amountData = window.chartAmountData || {
                buy: [0, 0, 0, 0],
                sell: [0, 0, 0, 0]
            };
            
            // è°ƒè¯•ä¿¡æ¯
            console.log('ğŸ“Š ä¹°å–é‡‘é¢å¯¹æ¯”å›¾æ•°æ®:', amountData);
            console.log('ğŸ“Š åˆ†ææ•°æ®é•¿åº¦:', analyzedData ? analyzedData.length : 0);
            
            // è½¬æ¢ä¸ºä¸‡å…ƒå•ä½ï¼ˆä¿æŒæ•°å€¼ç±»å‹ï¼‰
            const buySuper = parseFloat((amountData.buy[0] / 10000).toFixed(1));
            const buyLarge = parseFloat((amountData.buy[1] / 10000).toFixed(1));
            const buyMedium = parseFloat((amountData.buy[2] / 10000).toFixed(1));
            const buySmall = parseFloat((amountData.buy[3] / 10000).toFixed(1));
            
            const sellSuper = parseFloat((amountData.sell[0] / 10000).toFixed(1));
            const sellLarge = parseFloat((amountData.sell[1] / 10000).toFixed(1));
            const sellMedium = parseFloat((amountData.sell[2] / 10000).toFixed(1));
            const sellSmall = parseFloat((amountData.sell[3] / 10000).toFixed(1));

            console.log('ğŸ“Š è½¬æ¢åçš„ä¹°å…¥æ•°æ®:', [buySuper, buyLarge, buyMedium, buySmall]);
            console.log('ğŸ“Š è½¬æ¢åçš„å–å‡ºæ•°æ®:', [sellSuper, sellLarge, sellMedium, sellSmall]);

            // åˆ›å»ºä¹°å–åŠ›é‡å¯¹æ¯”æŸ±çŠ¶å›¾æ•°æ®
            const chartData = {
                labels: ['ç‰¹å¤§å•', 'å¤§å•', 'ä¸­å•', 'å°å•'],
                datasets: [
                    {
                        label: 'ä¹°å…¥é‡‘é¢(ä¸‡å…ƒ)',
                        data: [buySuper, buyLarge, buyMedium, buySmall],
                        backgroundColor: 'rgba(244, 67, 54, 0.8)'
                    },
                    {
                        label: 'å–å‡ºé‡‘é¢(ä¸‡å…ƒ)',
                        data: [sellSuper, sellLarge, sellMedium, sellSmall],
                        backgroundColor: 'rgba(76, 175, 80, 0.8)'
                    }
                ]
            };
            
            // ç»˜åˆ¶è‡ªå®šä¹‰æŸ±çŠ¶å›¾
            buySellChart.drawBarChart(chartData);
        }

        // è·å–é¢œè‰²çº§åˆ«å‡½æ•°
        function getColorLevels(data) {
            const colorLevels = [
                'rgba(139, 0, 0, 0.8)',     // æ·±çº¢è‰² 0-10%
                'rgba(178, 34, 34, 0.8)',   // ç«ç –çº¢ 10-20%
                'rgba(220, 20, 60, 0.8)',   // æ·±ç²‰çº¢ 20-30%
                'rgba(255, 69, 0, 0.8)',    // æ©™çº¢è‰² 30-40%
                'rgba(255, 140, 0, 0.8)',   // æ·±æ©™è‰² 40-50%
                'rgba(255, 165, 0, 0.8)',   // æ©™è‰² 50-60%
                'rgba(255, 215, 0, 0.8)',   // é‡‘è‰² 60-70%
                'rgba(154, 205, 50, 0.8)',  // é»„ç»¿è‰² 70-80%
                'rgba(50, 205, 50, 0.8)',   // é…¸æ©™ç»¿ 80-90%
                'rgba(0, 128, 0, 0.8)'      // ç»¿è‰² 90-100%
            ];
            
            return data.map(item => {
                const percentage = item.percentage;
                let colorIndex = 0;
                
                if (percentage <= 10) colorIndex = 0;
                else if (percentage <= 20) colorIndex = 1;
                else if (percentage <= 30) colorIndex = 2;
                else if (percentage <= 40) colorIndex = 3;
                else if (percentage <= 50) colorIndex = 4;
                else if (percentage <= 60) colorIndex = 5;
                else if (percentage <= 70) colorIndex = 6;
                else if (percentage <= 80) colorIndex = 7;
                else if (percentage <= 90) colorIndex = 8;
                else colorIndex = 9;
                
                return colorLevels[colorIndex];
            });
        }

        // æ›´æ–°æˆäº¤é‡å›¾è¡¨å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function updateVolumeChart(marketData) {
            const chartContainer = document.getElementById('volumeChart');
            if (!chartContainer) return;
            
            if (volumeChart) {
                volumeChart.destroy();
            }
            
            // åˆ›å»ºè‡ªå®šä¹‰å›¾è¡¨
            volumeChart = new CustomChart('volumeChart').init();
            
            if (!marketData || marketData.length === 0) {
                chartContainer.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            // å‡†å¤‡å›¾è¡¨æ•°æ®
            const chartType = document.getElementById('chartType').value;
            
            // è·å–æ•°æ®å€¼
            const dataValues = marketData.map(item => {
                let value = 0;
                if (chartType === 'volume') {
                    // æ”¯æŒå¤šç§æˆäº¤é‡å­—æ®µ
                    value = item.æˆäº¤é‡ || item.volume || item.vol || item.äº¤æ˜“é‡ || 0;
                } else {
                    // æ”¯æŒå¤šç§æˆäº¤é‡‘é¢å­—æ®µ
                    value = item.æˆäº¤é‡‘é¢ || item.amount || item.turnover || item.æˆäº¤é¢ || 0;
                }
                return parseFloat(value) || 0;
            });
            
            // è®¡ç®—æ•°å€¼èŒƒå›´ç”¨äºé¢œè‰²åˆ†çº§
            const maxValue = Math.max(...dataValues);
            const minValue = Math.min(...dataValues);
            
            // æ ¹æ®æ•°å€¼ç”Ÿæˆé¢œè‰²
            const generateColors = (values) => {
                return values.map(value => {
                    if (maxValue === minValue) {
                        return 'rgba(54, 162, 235, 0.8)'; // é»˜è®¤é¢œè‰²
                    }
                    
                    // è®¡ç®—ç›¸å¯¹ä½ç½® (0-1)
                    const ratio = (value - minValue) / (maxValue - minValue);
                    
                    // æ ¹æ®æ¯”ä¾‹åˆ†é…é¢œè‰²ï¼ˆä»çº¢è‰²åˆ°ç»¿è‰²ï¼‰
                    if (ratio <= 0.2) {
                        return 'rgba(220, 53, 69, 0.8)';   // æ·±çº¢è‰² (ä½å€¼)
                    } else if (ratio <= 0.4) {
                        return 'rgba(255, 193, 7, 0.8)';   // é»„è‰²
                    } else if (ratio <= 0.6) {
                        return 'rgba(54, 162, 235, 0.8)';  // è“è‰²
                    } else if (ratio <= 0.8) {
                        return 'rgba(40, 167, 69, 0.8)';   // ç»¿è‰²
                    } else {
                        return 'rgba(25, 135, 84, 0.8)';   // æ·±ç»¿è‰² (é«˜å€¼)
                    }
                });
            };
            
            const chartData = {
                labels: marketData.map(item => {
                    // æ”¯æŒå¤šç§æ—¥æœŸå­—æ®µæ ¼å¼
                    const dateStr = item.æ—¥æœŸ || item.date || item.trading_date || item.äº¤æ˜“æ—¥æœŸ || '';
                    if (!dateStr) return 'æœªçŸ¥æ—¥æœŸ';
                    
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) {
                        // å¦‚æœæ—¥æœŸè§£æå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ ¼å¼
                        return dateStr.length >= 8 ? dateStr.substring(4, 6) + '/' + dateStr.substring(6, 8) : dateStr;
                    }
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                }),
                datasets: [{
                    label: chartType === 'volume' ? 'æˆäº¤é‡' : 'æˆäº¤é‡‘é¢',
                    data: dataValues,
                    backgroundColor: generateColors(dataValues)
                }]
            };
            
            // ç»˜åˆ¶æŸ±çŠ¶å›¾
            volumeChart.drawBarChart(chartData);
        }


        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('errorDiv');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorDiv').style.display = 'none';
        }

        function showResults() {
            document.getElementById('resultsContainer').style.display = 'block';
        }

        function hideResults() {
            document.getElementById('resultsContainer').style.display = 'none';
        }

        function hideSuccess() {
            const successDiv = document.getElementById('successDiv');
            if (successDiv) {
                successDiv.style.display = 'none';
            }
        }

        function showProgress(show) {
            const progressDiv = document.getElementById('progressDiv');
            if (progressDiv) {
                progressDiv.style.display = show ? 'block' : 'none';
            }
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(step, percentage, message) {
            const progressDiv = document.getElementById('progressDiv');
            if (progressDiv) {
                // æ›´æ–°è¿›åº¦æ¡æ–‡æœ¬
                progressDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="margin-bottom: 10px;">æ­¥éª¤${step}: ${message}</div>
                        <div style="width: 100%; background-color: #f0f0f0; border-radius: 10px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 20px; background-color: #4CAF50; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="margin-top: 5px; font-size: 12px; color: #666;">${percentage}%</div>
                    </div>
                `;
            }
            
            console.log(`è¿›åº¦æ›´æ–°: æ­¥éª¤${step} - ${message} - ${percentage}%`);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successDiv');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥URLå‚æ•°å¹¶è‡ªåŠ¨åŠ è½½è‚¡ç¥¨
            const params = getUrlParams();
            if (params.code && /^\d{6}$/.test(params.code)) {
                console.log('ä»URLå‚æ•°åŠ è½½è‚¡ç¥¨:', params.code);
                const stockInput = document.getElementById('stockCode');
                if (stockInput) {
                    stockInput.value = params.code;
                    // è‡ªåŠ¨è§¦å‘åˆ†æ
                    setTimeout(function() {
                        analyzeStock();
                    }, 500);
                }
            }
            
            // æ·»åŠ å¤§å•ä¸Šé™å˜åŒ–ç›‘å¬å™¨ï¼Œè‡ªåŠ¨æ›´æ–°ç‰¹å¤§å•ä¸‹é™
            document.getElementById('largeThreshold').addEventListener('input', function() {
                const largeLimit = parseFloat(this.value);
                document.getElementById('superThreshold').value = largeLimit;
            });
            
            // åˆå§‹åŒ–ç‰¹å¤§å•ä¸‹é™
            const initialLargeLimit = parseFloat(document.getElementById('largeThreshold').value);
            document.getElementById('superThreshold').value = initialLargeLimit;
        });
        
        // ç›‘å¬URL hashå˜åŒ–
        window.addEventListener('hashchange', function() {
            const params = getUrlParams();
            if (params.code && /^\d{6}$/.test(params.code)) {
                console.log('URLå‚æ•°å˜åŒ–ï¼Œé‡æ–°åŠ è½½è‚¡ç¥¨:', params.code);
                const stockInput = document.getElementById('stockCode');
                if (stockInput) {
                    stockInput.value = params.code;
                    setTimeout(function() {
                        analyzeStock();
                    }, 500);
                }
            }
        });
    </script>
</body>
</html>
