<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œä¸šè¶‹åŠ¿åˆ†æ ï¼ˆå¤§å¸ˆç‰ˆï¼‰</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .period-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .period-btn:hover {
            background: #667eea;
            color: white;
        }

        .period-btn.active {
            background: #667eea;
            color: white;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 0.8s ease-out forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chart-container:nth-child(1) { animation-delay: 0.1s; }
        .chart-container:nth-child(2) { animation-delay: 0.2s; }
        .chart-container:nth-child(3) { animation-delay: 0.3s; }
        .chart-container:nth-child(4) { animation-delay: 0.4s; }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #495057;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .status-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .risk-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 1400px;
            text-align: center;
            color: #856404;
            font-size: 14px;
            line-height: 1.6;
        }

        .risk-warning strong {
            color: #dc3545;
            font-size: 16px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
        }

        .error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #dc3545;
            text-align: center;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #007bff;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>è¡Œä¸šè¶‹åŠ¿åˆ†æï¼ˆå¤§å¸ˆç‰ˆï¼‰</h1>
            <div>å®æ—¶è¡Œä¸šæ•°æ®åˆ†æä¸æ’è¡Œæ¦œ</div>
            <div style="font-size: 14px;  margin-top: 5px;">ä½œè€…ï¼š267278466@qq.com</div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label><i class="fas fa-calendar-alt"></i> æ—¶é—´å‘¨æœŸï¼š</label>
                <div class="period-buttons">
                <button class="period-btn" data-period="1">1æ—¥</button>
                <button class="period-btn" data-period="2">2æ—¥</button>
                <button class="period-btn active" data-period="5">5æ—¥</button>
                    <button class="period-btn" data-period="10">10æ—¥</button>
                    <button class="period-btn" data-period="20">20æ—¥</button>
                    <button class="period-btn" data-period="30">30æ—¥</button>
                    <button class="period-btn" data-period="60">60æ—¥</button>
                </div>
            </div>
            
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-trophy"></i> è¡Œä¸šèµ„é‡‘æ’è¡Œæ¦œ
                </div>
                <div class="chart-wrapper" id="rankingWrapper">
                    <div id="rankingChart" style="width: 100%; height: 400px;"></div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-chart-bar"></i> è¡Œä¸šæ¶¨è·Œå¹…æ’è¡Œæ¦œ
                </div>
                <div class="chart-wrapper" id="changeWrapper">
                    <div id="changeChart" style="width: 100%; height: 400px;"></div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-percentage"></i> æ¶¨è·Œé¢ä¸æ€»å¸‚å€¼æ¯”ä¾‹æ’è¡Œæ¦œ
                </div>
                <div class="chart-wrapper" id="marketCapWrapper">
                    <div id="marketCapChart" style="width: 100%; height: 400px;"></div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-balance-scale"></i> ä¸Šæ¶¨å®¶æ•°å æ¯”
                </div>
                <div class="chart-wrapper" id="ratioWrapper">
                    <div id="ratioChart" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- é£é™©è­¦å‘Š -->
    <div class="risk-warning">
        <strong>é£é™©æç¤ºï¼š</strong>æœ¬é¡µé¢æ•°æ®ä»…ä¾›å‚è€ƒï¼Œä¸åšä¸ºæŠ•èµ„æ¨èåŠå»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ã€‚<br>
        è‚¡ç¥¨æŠ•èµ„å­˜åœ¨ä»·æ ¼æ³¢åŠ¨é£é™©ï¼Œè¿‡å¾€ä¸šç»©ä¸ä»£è¡¨æœªæ¥è¡¨ç°ï¼Œè¯·æ ¹æ®è‡ªèº«é£é™©æ‰¿å—èƒ½åŠ›è°¨æ…æŠ•èµ„ã€‚
    </div>

    <!-- GitHubé“¾æ¥ -->
    <div style="text-align: center; margin: 30px auto; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 15px; max-width: 1400px;">
        <p style="color: #b0c4de; margin-bottom: 10px;">å¼€æºé¡¹ç›®</p>
        <a href="https://github.com/hengruiyun" target="_blank" style="color: #4CAF50; text-decoration: none; font-weight: bold; font-size: 16px;">
            <i class="fab fa-github"></i> è®¿é—®GitHub @hengruiyun
        </a>
    </div>

    <script>
        // è‡ªå®šä¹‰å›¾è¡¨ç±»
        class CustomChart {
            constructor(containerId) {
                this.containerId = containerId;
                this.container = document.getElementById(containerId);
                this.svg = null;
            }

            init() {
                if (!this.container) {
                    console.error(`Container ${this.containerId} not found`);
                    return this;
                }
                
                // æ¸…ç©ºå®¹å™¨
                this.container.innerHTML = '';
                
                // åˆ›å»ºSVG
                this.svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                this.svg.setAttribute('width', '100%');
                this.svg.setAttribute('height', '100%');
                this.svg.style.background = 'white';
                this.container.appendChild(this.svg);
                
                return this;
            }

            destroy() {
                if (this.container) {
                    this.container.innerHTML = '';
                }
            }

            drawBarChart(data) {
                if (!this.svg || !data || !data.labels || !data.datasets) return;
                
                const containerRect = this.container.getBoundingClientRect();
                const chartWidth = containerRect.width - 100;
                const chartHeight = containerRect.height - 100;
                const margin = { top: 20, right: 20, bottom: 60, left: 60 };
                
                // æ¸…ç©ºSVG
                this.svg.innerHTML = '';
                
                // åˆ›å»ºå›¾è¡¨ç»„
                const chartGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                chartGroup.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);
                chartGroup.style.opacity = '0';
                this.svg.appendChild(chartGroup);
                
                // æ·»åŠ è¿›åœºåŠ¨ç”»
                setTimeout(() => {
                    chartGroup.style.transition = 'opacity 0.6s ease-in-out';
                    chartGroup.style.opacity = '1';
                }, 100);
                
                const { labels, datasets } = data;
                
                if (!datasets || datasets.length === 0) {
                    // æ˜¾ç¤ºæ— æ•°æ®æç¤º
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', chartWidth / 2);
                    text.setAttribute('y', chartHeight / 2);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('font-size', '16');
                    text.setAttribute('fill', '#999');
                    text.textContent = 'æš‚æ— æ•°æ®';
                    chartGroup.appendChild(text);
                    return;
                }
                
                // è®¡ç®—æ•°æ®èŒƒå›´
                const allValues = datasets.flatMap(d => d.data || []);
                const validValues = allValues.filter(v => !isNaN(v) && isFinite(v));
                
                if (validValues.length === 0) {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', chartWidth / 2);
                    text.setAttribute('y', chartHeight / 2);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('font-size', '16');
                    text.setAttribute('fill', '#999');
                    text.textContent = 'æš‚æ— æ•°æ®';
                    chartGroup.appendChild(text);
                    return;
                }
                
                const maxValue = Math.max(...validValues.map(v => Math.abs(v)));
                const minValue = Math.min(...validValues);
                const range = maxValue - minValue;
                const adjustedMax = maxValue + range * 0.1;
                const adjustedMin = minValue - range * 0.1;
                
                // è®¡ç®—æŸ±å­å®½åº¦
                const barWidth = chartWidth / labels.length * 0.8;
                const barSpacing = chartWidth / labels.length * 0.2;
                
                // ç»˜åˆ¶Yè½´ç½‘æ ¼çº¿å’Œæ ‡ç­¾
                const gridLines = 5;
                for (let i = 0; i <= gridLines; i++) {
                    const y = (chartHeight / gridLines) * i;
                    const value = adjustedMax - (range / gridLines) * i;
                    
                    // ç½‘æ ¼çº¿
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', 0);
                    line.setAttribute('y1', y);
                    line.setAttribute('x2', chartWidth);
                    line.setAttribute('y2', y);
                    line.setAttribute('stroke', '#e0e0e0');
                    line.setAttribute('stroke-width', 1);
                    chartGroup.appendChild(line);
                    
                    // Yè½´æ ‡ç­¾
                    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    label.setAttribute('x', -10);
                    label.setAttribute('y', y + 5);
                    label.setAttribute('text-anchor', 'end');
                    label.setAttribute('font-size', '12');
                    label.setAttribute('fill', '#666');
                    label.textContent = value.toFixed(1);
                    chartGroup.appendChild(label);
                }
                
                // ç»˜åˆ¶Xè½´å’ŒYè½´
                const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                xAxis.setAttribute('x1', 0);
                xAxis.setAttribute('y1', chartHeight);
                xAxis.setAttribute('x2', chartWidth);
                xAxis.setAttribute('y2', chartHeight);
                xAxis.setAttribute('stroke', '#333');
                xAxis.setAttribute('stroke-width', 2);
                chartGroup.appendChild(xAxis);
                
                const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                yAxis.setAttribute('x1', 0);
                yAxis.setAttribute('y1', 0);
                yAxis.setAttribute('x2', 0);
                yAxis.setAttribute('y2', chartHeight);
                yAxis.setAttribute('stroke', '#333');
                yAxis.setAttribute('stroke-width', 2);
                chartGroup.appendChild(yAxis);
                
                // ç»˜åˆ¶æŸ±å­
                labels.forEach((label, i) => {
                    const x = i * (barWidth + barSpacing);
                    
                    datasets.forEach((dataset, datasetIndex) => {
                        const value = dataset.data[i] || 0;
                        
                        if (isNaN(value) || !isFinite(value)) return;
                        
                        const barHeight = (Math.abs(value - adjustedMin) / range) * chartHeight;
                        const y = chartHeight - barHeight;
                        
                        if (isNaN(barHeight) || isNaN(y) || !isFinite(barHeight) || !isFinite(y)) return;
                        
                        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        rect.setAttribute('x', x + (datasetIndex * barWidth / datasets.length));
                        rect.setAttribute('y', chartHeight); // ä»åº•éƒ¨å¼€å§‹
                        rect.setAttribute('width', barWidth / datasets.length);
                        rect.setAttribute('height', 0); // åˆå§‹é«˜åº¦ä¸º0
                        rect.setAttribute('fill', dataset.backgroundColor || '#4ecdc4');
                        rect.setAttribute('opacity', 0.8);
                        
                        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                        setTimeout(() => {
                            rect.style.transition = 'y 0.8s ease-out, height 0.8s ease-out';
                            rect.setAttribute('y', y);
                            rect.setAttribute('height', barHeight);
                        }, i * 100 + datasetIndex * 50); // é”™å¼€åŠ¨ç”»æ—¶é—´
                        
                        // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
                        rect.addEventListener('mouseover', function() {
                            this.setAttribute('opacity', 1);
                        });
                        rect.addEventListener('mouseout', function() {
                            this.setAttribute('opacity', 0.8);
                        });
                        
                        chartGroup.appendChild(rect);
                    });
                    
                    // Xè½´æ ‡ç­¾
                    const labelElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    labelElement.setAttribute('x', x + barWidth / 2);
                    labelElement.setAttribute('y', chartHeight + 20);
                    labelElement.setAttribute('text-anchor', 'middle');
                    labelElement.setAttribute('font-size', '12');
                    labelElement.setAttribute('fill', '#666');
                    labelElement.textContent = label.length > 8 ? label.substring(0, 8) + '...' : label;
                    chartGroup.appendChild(labelElement);
                });
            }
        }

        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function debugLog(message) {
            }

        debugLog('é¡µé¢å¼€å§‹åŠ è½½...');

        // ç»Ÿä¸€çš„æœåŠ¡å™¨åœ°å€è·å–å‡½æ•°
        function getServerUrl() {
            const protocol = window.location.protocol;
            
            // å¦‚æœæ˜¯é€šè¿‡HTTP/HTTPSè®¿é—®ï¼ˆä»æœåŠ¡å™¨åŠ è½½çš„ï¼‰ï¼Œç›´æ¥ä½¿ç”¨å½“å‰åœ°å€çš„åŸŸåå’Œç«¯å£
            if (protocol === 'http:' || protocol === 'https:') {
                return window.location.origin;
            }
            
            // å¦‚æœæ˜¯fileåè®®ï¼Œå›é€€åˆ°localhost:16888
            return 'http://localhost:16888';
        }
        
        // å…¨å±€å˜é‡
        const LOCAL_SERVER = getServerUrl();
        let currentPeriod = '5';
        let charts = {};
        let isLoading = false;

        debugLog('å…¨å±€å˜é‡åˆå§‹åŒ–å®Œæˆ');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            try {
                setupEventListeners();
                debugLog('äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
                
                initializeCharts();
                debugLog('å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
                
                refreshAllData();
                debugLog('å¼€å§‹é¦–æ¬¡æ•°æ®åŠ è½½');
                
            } catch (error) {
                debugLog('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            debugLog('è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...');
            
            // å‘¨æœŸæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.period-btn').forEach((btn, index) => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const period = this.dataset.period;
                    debugLog(`å‘¨æœŸæŒ‰é’®ç‚¹å‡»: ${period}æ—¥`);
                    
                    if (isLoading) {
                        debugLog('æ­£åœ¨åŠ è½½ä¸­ï¼Œå¿½ç•¥ç‚¹å‡»');
                        return;
                    }
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // æ›´æ–°å½“å‰å‘¨æœŸ
                    if (period !== currentPeriod) {
                        currentPeriod = period;
                        debugLog(`åˆ‡æ¢åˆ°å‘¨æœŸ: ${currentPeriod}æ—¥`);
                        refreshAllData();
                    }
                });
            });

            debugLog('äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
        }

        // åˆå§‹åŒ–å›¾è¡¨
        function initializeCharts() {
            debugLog('å¼€å§‹åˆå§‹åŒ–å›¾è¡¨...');
            
            try {
                // è¡Œä¸šæ’è¡Œæ¦œ
                charts.ranking = new CustomChart('rankingChart').init();
                debugLog('æ’è¡Œæ¦œå›¾è¡¨åˆå§‹åŒ–å®Œæˆ');

                // æ¶¨è·Œå¹…å›¾è¡¨
                charts.change = new CustomChart('changeChart').init();
                debugLog('æ¶¨è·Œå¹…å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');

                // å¸‚å€¼æ¯”ä¾‹å›¾è¡¨
                charts.marketCap = new CustomChart('marketCapChart').init();
                debugLog('å¸‚å€¼æ¯”ä¾‹å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');

                // ä¸Šæ¶¨ä¸‹è·Œæ¯”ä¾‹å›¾è¡¨
                charts.ratio = new CustomChart('ratioChart').init();
                debugLog('ä¸Šæ¶¨ä¸‹è·Œæ¯”ä¾‹å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                debugLog('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                throw error;
            }
        }

        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshAllData() {
            if (isLoading) {
                debugLog('å·²åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
                return;
            }
            
            debugLog(`å¼€å§‹åˆ·æ–°æ•°æ®ï¼Œå½“å‰å‘¨æœŸ: ${currentPeriod}æ—¥`);
            isLoading = true;

            try {
                debugLog('å¼€å§‹å¹¶è¡Œè·å–æ‰€æœ‰APIæ•°æ®...');
                
                // æµ‹è¯•æœåŠ¡å™¨è¿æ¥
                const testResponse = await fetch(`${LOCAL_SERVER}/api/status`);
                if (!testResponse.ok) {
                    throw new Error('æœåŠ¡å™¨è¿æ¥å¤±è´¥');
                }
                debugLog('æœåŠ¡å™¨è¿æ¥æ­£å¸¸');
                
                // å¹¶è¡Œè·å–æ‰€æœ‰æ•°æ®
                const [rankingData, changeData, marketCapData, ratioData] = await Promise.all([
                    fetchIndustryRanking(),
                    fetchIndustryChangeRanking(),
                    fetchIndustryMarketCapRatio(),
                    fetchIndustryUpDownRatio()
                ]);

                debugLog(`APIæ•°æ®è·å–å®Œæˆ: ranking=${rankingData?.success}, change=${changeData?.success}, marketCap=${marketCapData?.success}, ratio=${ratioData?.success}`);

                // æ›´æ–°å›¾è¡¨
                updateRankingChart(rankingData);
                updateChangeChart(changeData);
                updateMarketCapChart(marketCapData);
                updateRatioChart(ratioData);

                // æ›´æ–°çŠ¶æ€ä¿¡æ¯
                updateStatusInfo(rankingData);
                
                debugLog('æ‰€æœ‰å›¾è¡¨æ›´æ–°å®Œæˆ');

            } catch (error) {
                debugLog('åˆ·æ–°æ•°æ®å¤±è´¥: ' + error.message);
                showError('é”™è¯¯ï¼Œæ£€æŸ¥ç½‘ç»œè¿æ¥å’Œå¤§å¸ˆæœåŠ¡å™¨çŠ¶æ€');
            } finally {
                isLoading = false;
                debugLog('æ•°æ®åˆ·æ–°æµç¨‹ç»“æŸ');
            }
        }

        // APIè·å–å‡½æ•°
        async function fetchIndustryRanking() {
            debugLog(`è·å–æ’è¡Œæ¦œæ•°æ®: period=${currentPeriod}`);
            const response = await fetch(`${LOCAL_SERVER}/api/industry/ranking?period=${currentPeriod}&limit=10`);
            if (!response.ok) {
                throw new Error(`æ’è¡Œæ¦œAPIå¤±è´¥: HTTP ${response.status}`);
            }
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || 'è·å–æ’è¡Œæ¦œæ•°æ®å¤±è´¥');
            }
            debugLog(`æ’è¡Œæ¦œæ•°æ®è·å–æˆåŠŸ: ${data.data.length}æ¡è®°å½•`);
            return data;
        }

        async function fetchIndustryChangeRanking() {
            debugLog(`è·å–æ¶¨è·Œå¹…æ•°æ®: period=${currentPeriod}`);
            const response = await fetch(`${LOCAL_SERVER}/api/industry/change_ranking?period=${currentPeriod}&limit=10&order=desc`);
            if (!response.ok) {
                throw new Error(`æ¶¨è·Œå¹…APIå¤±è´¥: HTTP ${response.status}`);
            }
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || 'è·å–æ¶¨è·Œå¹…æ•°æ®å¤±è´¥');
            }
            debugLog(`æ¶¨è·Œå¹…æ•°æ®è·å–æˆåŠŸ: ${data.data.length}æ¡è®°å½•`);
            return data;
        }

        async function fetchIndustryMarketCapRatio() {
            debugLog(`è·å–å¸‚å€¼æ¯”ä¾‹æ•°æ®: period=${currentPeriod}`);
            const response = await fetch(`${LOCAL_SERVER}/api/industry/market_cap_ratio?period=${currentPeriod}&limit=10`);
            if (!response.ok) {
                throw new Error(`å¸‚å€¼æ¯”ä¾‹APIå¤±è´¥: HTTP ${response.status}`);
            }
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || 'è·å–å¸‚å€¼æ¯”ä¾‹æ•°æ®å¤±è´¥');
            }
            debugLog(`å¸‚å€¼æ¯”ä¾‹æ•°æ®è·å–æˆåŠŸ: ${data.data.length}æ¡è®°å½•`);
            return data;
        }

        async function fetchIndustryUpDownRatio() {
            debugLog(`è·å–ä¸Šæ¶¨ä¸‹è·Œæ¯”ä¾‹æ•°æ®: period=${currentPeriod}`);
            const response = await fetch(`${LOCAL_SERVER}/api/industry/up_down_ratio?period=${currentPeriod}&limit=10`);
            if (!response.ok) {
                throw new Error(`ä¸Šæ¶¨ä¸‹è·Œæ¯”ä¾‹APIå¤±è´¥: HTTP ${response.status}`);
            }
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || 'è·å–ä¸Šæ¶¨ä¸‹è·Œæ¯”ä¾‹æ•°æ®å¤±è´¥');
            }
            debugLog(`ä¸Šæ¶¨ä¸‹è·Œæ¯”ä¾‹æ•°æ®è·å–æˆåŠŸ: ${data.data.length}æ¡è®°å½•`);
            return data;
        }

        // å›¾è¡¨æ›´æ–°å‡½æ•°
        function updateRankingChart(data) {
            debugLog('æ›´æ–°æ’è¡Œæ¦œå›¾è¡¨...');
            if (!data || !data.data || !Array.isArray(data.data)) {
                debugLog('æ’è¡Œæ¦œæ•°æ®æ ¼å¼é”™è¯¯');
                return;
            }
            
            const chart = charts.ranking;
            const industries = data.data.map(item => item.è¡Œä¸š || 'æœªçŸ¥è¡Œä¸š');
            const netAmounts = data.data.map(item => parseFloat(item.å‡€é¢ || 0));

            debugLog(`æ’è¡Œæ¦œæ•°æ®è¯¦æƒ…: è¡Œä¸š=${industries.join(', ')}, å‡€é¢=${netAmounts.join(', ')}`);
            
            const chartData = {
                labels: industries,
                datasets: [{
                    label: 'å‡€æµå…¥(äº¿å…ƒ)',
                    data: netAmounts,
                    backgroundColor: 'rgba(102, 126, 234, 0.8)'
                }]
            };
            
            chart.drawBarChart(chartData);
            debugLog(`æ’è¡Œæ¦œå›¾è¡¨æ›´æ–°å®Œæˆ: ${industries.length}ä¸ªè¡Œä¸š`);
        }

        function updateChangeChart(data) {
            debugLog('æ›´æ–°æ¶¨è·Œå¹…å›¾è¡¨...');
            if (!data || !data.data || !Array.isArray(data.data)) {
                debugLog('æ¶¨è·Œå¹…æ•°æ®æ ¼å¼é”™è¯¯');
                return;
            }
            
            const chart = charts.change;
            const industries = data.data.map(item => item.è¡Œä¸š || 'æœªçŸ¥è¡Œä¸š');
            const changes = data.data.map(item => {
                let changeValue = 0;
                if (item['æ¶¨è·Œå¹…']) {
                    changeValue = parseFloat(item['æ¶¨è·Œå¹…'].toString().replace('%', '')) || 0;
                } else if (item['è¡Œä¸š-æ¶¨è·Œå¹…'] !== undefined) {
                    changeValue = parseFloat(item['è¡Œä¸š-æ¶¨è·Œå¹…']) || 0;
                } else if (item['é˜¶æ®µæ¶¨è·Œå¹…']) {
                    changeValue = parseFloat(item['é˜¶æ®µæ¶¨è·Œå¹…'].toString().replace('%', '')) || 0;
                }
                return changeValue;
            });

            debugLog(`æ¶¨è·Œå¹…æ•°æ®è¯¦æƒ…: è¡Œä¸š=${industries.join(', ')}, æ¶¨è·Œå¹…=${changes.join(', ')}%`);

            const chartData = {
                labels: industries,
                datasets: [{
                    label: 'æ¶¨è·Œå¹… (%)',
                    data: changes,
                    backgroundColor: 'rgba(220, 53, 69, 0.8)'
                }]
            };
            
            chart.drawBarChart(chartData);
            debugLog(`æ¶¨è·Œå¹…å›¾è¡¨æ›´æ–°å®Œæˆ: ${industries.length}ä¸ªè¡Œä¸š`);
        }

        function updateMarketCapChart(data) {
            debugLog('æ›´æ–°å¸‚å€¼æ¯”ä¾‹å›¾è¡¨...');
            if (!data || !data.data || !Array.isArray(data.data)) {
                debugLog('å¸‚å€¼æ¯”ä¾‹æ•°æ®æ ¼å¼é”™è¯¯');
                return;
            }
            
            const chart = charts.marketCap;
            const industries = data.data.map(item => item.è¡Œä¸š || 'æœªçŸ¥è¡Œä¸š');
            const ratios = data.data.map(item => parseFloat(item.å¸‚å€¼æ¯”ä¾‹ || 0));

            debugLog(`å¸‚å€¼æ¯”ä¾‹æ•°æ®è¯¦æƒ…: è¡Œä¸š=${industries.join(', ')}, å¸‚å€¼æ¯”ä¾‹=${ratios.join(', ')}%`);

            const chartData = {
                labels: industries,
                datasets: [{
                    label: 'å¸‚å€¼æ¯”ä¾‹ (%)',
                    data: ratios,
                    backgroundColor: 'rgba(156, 39, 176, 0.8)'
                }]
            };
            
            chart.drawBarChart(chartData);
            debugLog(`å¸‚å€¼æ¯”ä¾‹å›¾è¡¨æ›´æ–°å®Œæˆ: ${industries.length}ä¸ªè¡Œä¸š`);
        }

        function updateRatioChart(data) {
            debugLog('æ›´æ–°ä¸Šæ¶¨ä¸‹è·Œæ¯”ä¾‹å›¾è¡¨...');
            if (!data || !data.data || !Array.isArray(data.data)) {
                debugLog('ä¸Šæ¶¨ä¸‹è·Œæ¯”ä¾‹æ•°æ®æ ¼å¼é”™è¯¯');
                return;
            }
            
            const chart = charts.ratio;
            const industries = data.data.map(item => item.è¡Œä¸š || 'æœªçŸ¥è¡Œä¸š');
            const ratios = data.data.map(item => parseFloat(item.ä¸Šæ¶¨æ¯”ä¾‹ || 0));

            debugLog(`ä¸Šæ¶¨ä¸‹è·Œæ¯”ä¾‹æ•°æ®è¯¦æƒ…: è¡Œä¸š=${industries.join(', ')}, ä¸Šæ¶¨æ¯”ä¾‹=${ratios.join(', ')}%`);

            const chartData = {
                labels: industries,
                datasets: [{
                    label: 'ä¸Šæ¶¨å æ¯”(%)',
                    data: ratios,
                    backgroundColor: 'rgba(255, 193, 7, 0.8)'
                }]
            };
            
            chart.drawBarChart(chartData);
            debugLog(`ä¸Šæ¶¨ä¸‹è·Œæ¯”ä¾‹å›¾è¡¨æ›´æ–°å®Œæˆ: ${industries.length}ä¸ªè¡Œä¸š`);
        }

        // æ›´æ–°çŠ¶æ€ä¿¡æ¯
        function updateStatusInfo(data) {
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            debugLog('æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯: ' + message);
            document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
                wrapper.innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <div>${message}</div>
                            <div style="font-size: 14px; margin-top: 10px;">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€</div>
                        </div>
                    </div>
                `;
            });
        }

        debugLog('è„šæœ¬åŠ è½½å®Œæˆï¼Œç­‰å¾…DOMåŠ è½½...');
        
        // æœ¬åœ°ç¯å¢ƒæ”¯æŒï¼šè‚¡ç¥¨ä»£ç è¯†åˆ«å’Œå¹¿æ’­åŠŸèƒ½
        if (!window.broadcastStockCode) {
            console.log('ğŸ  æœ¬åœ°ç¯å¢ƒï¼šå¯åŠ¨å†…ç½®è‚¡ç¥¨ä»£ç è¯†åˆ«');
            
            // æœ¬åœ°ç¯å¢ƒçš„å¹¿æ’­å‡½æ•°
            async function broadcastStockCode(stockCode) {
                try {
                    const response = await fetch(`http://localhost:16888/api/broadcast`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ stock_code: stockCode })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('âœ“ æœ¬åœ°ç¯å¢ƒå¹¿æ’­æˆåŠŸ:', result);
                    } else {
                        console.log('âœ— æœ¬åœ°ç¯å¢ƒå¹¿æ’­å¤±è´¥:', response.statusText);
                    }
                } catch (error) {
                    console.log('âœ— æœ¬åœ°ç¯å¢ƒå¹¿æ’­å¤±è´¥:', error.message);
                }
            }
            
            // æœ¬åœ°ç¯å¢ƒçš„è‚¡ç¥¨ä»£ç è¯†åˆ«å‡½æ•°
            function convertStockCodesToLinks(container = document.body) {
                // ç¡®ä¿containeræ˜¯DOMå…ƒç´ 
                if (!container || typeof container.querySelectorAll !== 'function') {
                    container = document.body;
                }
                
                const textElements = container.querySelectorAll('p, span, div, td, li, h1, h2, h3, h4, h5, h6');
                
                textElements.forEach(element => {
                    // è·³è¿‡å·²å¤„ç†çš„å…ƒç´ 
                    if (element.classList.contains('stock-code-processed')) return;
                    
                    // è·³è¿‡è¾“å…¥æ¡†ã€æŒ‰é’®ç­‰
                    if (element.tagName.match(/^(INPUT|BUTTON|TEXTAREA|SELECT)$/)) return;
                    
                    let content = element.textContent;
                    if (!content || content.trim().length === 0) return;
                    
                    // åŒ¹é…6ä½æ•°å­—çš„è‚¡ç¥¨ä»£ç 
                    const stockCodeRegex = /\b(\d{6})\b/g;
                    let hasMatch = false;
                    
                    content = content.replace(stockCodeRegex, (match, code) => {
                        // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆè‚¡ç¥¨ä»£ç ï¼ˆä»¥0ã€3ã€6å¼€å¤´ï¼‰
                        if (code.match(/^[036]/)) {
                            hasMatch = true;
                            return `<a href="javascript:void(0)" class="stock-code-link" onclick="broadcastStockCode('${code}')" style="color: #1976d2; text-decoration: underline; cursor: pointer;" title="ç‚¹å‡»å¹¿æ’­åˆ°é€šè¾¾ä¿¡">${code}</a>`;
                        }
                        return match;
                    });
                    
                    if (hasMatch) {
                        element.innerHTML = content;
                        element.classList.add('stock-code-processed');
                    }
                });
            }
            
            // è®¾ç½®MutationObserverç›‘å¬DOMå˜åŒ–
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                convertStockCodesToLinks(node);
                            }
                        });
                    }
                });
            });
            
            // å¯åŠ¨è§‚å¯Ÿå™¨
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // åˆå§‹å¤„ç†
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(convertStockCodesToLinks, 500);
                });
            } else {
                setTimeout(convertStockCodesToLinks, 500);
            }
            
            console.log('âœ… æœ¬åœ°ç¯å¢ƒMutationObserverå·²å¯åŠ¨');
        }
    </script>
</body>
</html>

