<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿·ä½ æŠ•èµ„å¤§å¸ˆ ï¼ˆå¤§å¸ˆç‰ˆï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .author-info {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 10px;
        }

        .risk-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px;
            text-align: center;
            color: #856404;
            font-size: 14px;
            line-height: 1.6;
        }

        .risk-warning strong {
            color: #dc3545;
            font-size: 16px;
        }
        
        .search-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }
        
        .search-form {
            display: flex;
            gap: 15px;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .search-button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            display: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        .analysis-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .analysis-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .master-score {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .score-excellent { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .score-good { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .score-average { background: linear-gradient(135deg, #3498db, #2980b9); }
        .score-poor { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        
        .strategy-breakdown {
            margin-top: 20px;
        }
        
        .strategy-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .strategy-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .strategy-score {
            font-weight: bold;
            padding: 5px 12px;
            border-radius: 20px;
            color: white;
            font-size: 0.9em;
        }
        
        .score-high { background: #27ae60; }
        .score-medium { background: #f39c12; }
        .score-low { background: #e74c3c; }
        
        .recommendation {
            text-align: center;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: white;
            font-size: 1.1em;
        }
        
        .rec-buy { background: linear-gradient(135deg, #e74c3c, #c0392b); }  /* çº¢æ¶¨ */
        .rec-sell { background: linear-gradient(135deg, #27ae60, #2ecc71); } /* ç»¿è·Œ */
        .rec-hold { background: linear-gradient(135deg, #3498db, #2980b9); }
        
        .insights-list {
            list-style: none;
            padding: 0;
        }
        
        .insights-list li {
            padding: 10px 0;
            border-left: 4px solid #3498db;
            padding-left: 15px;
            margin-bottom: 10px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 0 8px 8px 0;
        }
        
        .data-sources {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .data-sources h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .data-sources ul {
            list-style-type: none;
            padding: 0;
        }
        
        .data-sources li {
            padding: 5px 0;
            color: #7f8c8d;
        }
        
        .data-sources li:before {
            content: "âœ“ ";
            color: #27ae60;
            font-weight: bold;
        }
        
        .error {
            display: none;
            text-align: center;
            padding: 50px;
            color: #e74c3c;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 768px) {
            .analysis-grid {
                grid-template-columns: 1fr;
                padding: 20px;
            }
            
            .search-form {
                flex-direction: column;
            }
            
            .search-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>è¿·ä½ æŠ•èµ„å¤§å¸ˆ ï¼ˆå¤§å¸ˆç‰ˆï¼‰</h1>
            <div class="subtitle">èåˆæŠ€æœ¯åˆ†æã€èµ„é‡‘æµå‘ã€å¸‚åœºæƒ…ç»ªçš„æ™ºèƒ½å†³ç­–</div>
            <div class="subtitle">ä½œè€…ï¼š267278466@qq.com</div>
        </div>
        
        <div class="search-section">
            <div class="search-form">
                <input type="text" id="stockCode" class="search-input" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚: 600000, 000001)" maxlength="6">
                <button class="search-button" onclick="analyzeStock()">æ·±åº¦åˆ†æ</button>
                <button class="search-button" onclick="openSmartAnalysis()" style="margin-left: 10px; background: linear-gradient(135deg, #17a2b8, #28a745); border: none;">
                    <i class="fas fa-chart-line"></i> ä¸ªè‚¡åˆ†æ
                </button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨è¿›è¡Œæ·±åº¦åˆ†æï¼Œè¯·ç¨å€™...</p>
        </div>
        
        <div class="error" id="error">
            <h3>é”™è¯¯ï¼Œæ£€æŸ¥ç½‘ç»œè¿æ¥å’Œå¤§å¸ˆæœåŠ¡å™¨çŠ¶æ€</h3>
            <p id="errorMessage"></p>
        </div>
        
        <div class="results" id="results">
            <div class="analysis-grid">
                <!-- ç»¼åˆè¯„åˆ† -->
                <div class="analysis-card">
                    <h3>ğŸ¯ æŠ•èµ„å¤§å¸ˆç»¼åˆè¯„åˆ†</h3>
                    <div class="master-score" id="masterScore">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="strategy-breakdown" id="strategyBreakdown">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- æŠ•èµ„å»ºè®® -->
                <div class="analysis-card">
                    <h3>ğŸ’¡ æ™ºèƒ½æŠ•èµ„å»ºè®®</h3>
                    <div id="recommendation">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="data-sources">
                        <h4>åˆ†æä¾æ®</h4>
                        <ul id="analysisBasis">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </ul>
                    </div>
                </div>
                
                <!-- æ·±åº¦æ´å¯Ÿ -->
                <div class="analysis-card full-width">
                    <h3>ğŸ” æŠ•èµ„å¤§å¸ˆæ´å¯Ÿ</h3>
                    <ul class="insights-list" id="masterInsights">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç»Ÿä¸€çš„æœåŠ¡å™¨åœ°å€è·å–å‡½æ•°
        function getServerUrl() {
            const protocol = window.location.protocol;
            
            // å¦‚æœæ˜¯é€šè¿‡HTTP/HTTPSè®¿é—®ï¼ˆä»æœåŠ¡å™¨åŠ è½½çš„ï¼‰ï¼Œç›´æ¥ä½¿ç”¨å½“å‰åœ°å€çš„åŸŸåå’Œç«¯å£
            if (protocol === 'http:' || protocol === 'https:') {
                return window.location.origin;
            }
            
            // å¦‚æœæ˜¯fileåè®®ï¼Œå›é€€åˆ°localhost:16888
            return 'http://localhost:16888';
        }
        
        const LOCAL_SERVER = getServerUrl();
        
        // å…¨å±€å˜é‡ä¿å­˜å½“å‰åˆ†æçš„è‚¡ç¥¨ä¿¡æ¯
        let globalCurrentStockCode = '';
        let globalCurrentStockName = '';
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('results').style.display = 'none';
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResults() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('results').style.display = 'block';
        }
        
        // éªŒè¯è‚¡ç¥¨ä»£ç 
        function validateStockCode(code) {
            return /^[0-9]{6}$/.test(code);
        }

        function decodeText(value) {
            if (!value) return '';
            try {
                return decodeURIComponent(escape(value));
            } catch (error) {
                return value;
            }
        }
        
        // è·å–è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ï¼ˆä½¿ç”¨æœ¬åœ°æ•°æ®ï¼‰
        async function fetchStockBasic(code) {
            try {
                const response = await fetch(`${LOCAL_SERVER}/api/stock/basic`);
                if (!response.ok) throw new Error('è·å–åŸºæœ¬ä¿¡æ¯å¤±è´¥');
                
                const data = await response.json();
                if (!data.success) throw new Error(data.message || 'è·å–åŸºæœ¬ä¿¡æ¯å¤±è´¥');
                
                const list = Array.isArray(data.data) ? data.data : [];
                const stockInfo = list.find(item => item.code === code || item.symbol === code);
                if (!stockInfo) {
                    throw new Error(`è‚¡ç¥¨ä»£ç  ${code} ä¸å­˜åœ¨`);
                }

                const name = decodeText(stockInfo.name || '');
                const symbol = stockInfo.code || stockInfo.symbol || code;

                return {
                    ...stockInfo,
                    code: symbol,
                    symbol: symbol,
                    name: name || code
                };
            } catch (error) {
                throw error;
            }
        }
        
        // è·å–è‚¡ç¥¨è¡Œæƒ…æ•°æ®
        async function fetchStockMarket(code) {
            try {
                const response = await fetch(`${LOCAL_SERVER}/api/lj/stock/history?symbol=${code}&market=CN&top_n=200`);
                if (!response.ok) throw new Error('è·å–è¡Œæƒ…æ•°æ®å¤±è´¥');
                
                const data = await response.json();
                if (!data.success) throw new Error(data.message || 'è·å–è¡Œæƒ…æ•°æ®å¤±è´¥');

                const records = Array.isArray(data.data) ? data.data : [];
                if (records.length === 0) {
                    throw new Error('è¯¥è‚¡ç¥¨æ²¡æœ‰è¡Œæƒ…æ•°æ®');
                }

                const normalized = records
                    .map(item => ({
                        date: item.date || item.trade_date,
                        close: Number(item.close ?? item['æ”¶ç›˜ä»·'] ?? 0),
                        open: Number(item.open ?? item['å¼€ç›˜ä»·'] ?? 0),
                        high: Number(item.high ?? item['æœ€é«˜ä»·'] ?? 0),
                        low: Number(item.low ?? item['æœ€ä½ä»·'] ?? 0),
                        volume: Number(item.volume ?? item['æˆäº¤é‡'] ?? 0),
                        amount: Number(item.amount ?? item['æˆäº¤é¢'] ?? 0)
                    }))
                    .filter(item => item.date)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                if (normalized.length < 20) {
                    throw new Error(`æ•°æ®ä¸è¶³ï¼Œæ— æ³•è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ï¼ˆéœ€è¦è‡³å°‘20ä¸ªäº¤æ˜“æ—¥æ•°æ®ï¼Œå½“å‰ä»…æœ‰${normalized.length}ä¸ªäº¤æ˜“æ—¥ï¼‰`);
                }

                return normalized;
            } catch (error) {
                throw error;
            }
        }
        
        // è·å–èµ„é‡‘æµå‘æ•°æ®ï¼ˆä½¿ç”¨æœ¬åœ°æ•°æ®ï¼‰
        async function fetchMoneyFlow(code) {
            try {
                const response = await fetch(`${LOCAL_SERVER}/api/lj/money/flow?symbol=${code}&top_n=200`);
                if (!response.ok) throw new Error('è·å–èµ„é‡‘æµå‘æ•°æ®å¤±è´¥');
                
                const data = await response.json();
                if (!data.success) throw new Error(data.message || data.error || 'è·å–èµ„é‡‘æµå‘æ•°æ®å¤±è´¥');
                
                const records = Array.isArray(data.data) ? data.data : [];
                if (records.length === 0) {
                    throw new Error('è¯¥è‚¡ç¥¨æ²¡æœ‰èµ„é‡‘æµå‘æ•°æ®');
                }
                
                return records
                    .map(item => ({
                        trade_date: item.trade_date || item.date,
                        net_amount: Number(item.net_mf_amount ?? item.net_amount ?? 0),
                        buy_elg_amount: Number(item.buy_elg_amount ?? 0),
                        buy_lg_amount: Number(item.buy_lg_amount ?? 0),
                        buy_md_amount: Number(item.buy_md_amount ?? 0),
                        buy_sm_amount: Number(item.buy_sm_amount ?? 0),
                        sell_elg_amount: Number(item.sell_elg_amount ?? 0),
                        sell_lg_amount: Number(item.sell_lg_amount ?? 0),
                        sell_md_amount: Number(item.sell_md_amount ?? 0),
                        sell_sm_amount: Number(item.sell_sm_amount ?? 0)
                    }))
                    .filter(item => item.trade_date)
                    .sort((a, b) => new Date(a.trade_date) - new Date(b.trade_date));
            } catch (error) {
                throw error;
            }
        }
        
        // è·å–å¤§å•æ•°æ®ï¼ˆåŸºäºèµ„é‡‘æµå‘çš„ç‰¹å¤§/å¤§å•ç»Ÿè®¡ï¼‰
        async function fetchLargeOrders(code, existingMoneyFlow = null) {
            try {
                const source = Array.isArray(existingMoneyFlow) && existingMoneyFlow.length > 0
                    ? existingMoneyFlow
                    : await fetchMoneyFlow(code);

                const recent = source.slice(-10);
                if (recent.length === 0) {
                    throw new Error('è¯¥è‚¡ç¥¨æ²¡æœ‰å¤§å•æ•°æ®');
                }

                return recent.map(item => ({
                    date: item.trade_date,
                    buyAmount: ((item.buy_elg_amount || 0) + (item.buy_lg_amount || 0)) / 10000,
                    sellAmount: ((item.sell_elg_amount || 0) + (item.sell_lg_amount || 0)) / 10000
                }));
            } catch (error) {
                throw error;
            }
        }
        
        // è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
        function calculateTechnicalIndicators(marketData) {
            if (!Array.isArray(marketData) || marketData.length < 20) {
                throw new Error('æ•°æ®ä¸è¶³ï¼Œæ— æ³•è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ï¼ˆéœ€è¦è‡³å°‘20ä¸ªäº¤æ˜“æ—¥æ•°æ®ï¼‰');
            }

            const recent = marketData.slice(-60);
            const closes = recent.map(item => Number(item.close || 0));
            const volumes = recent.map(item => Number(item.volume || 0));

            const currentPrice = closes[closes.length - 1];

            const avg = (arr, count) => {
                if (arr.length < count) {
                    throw new Error(`æ•°æ®ä¸è¶³ï¼Œæ— æ³•è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ï¼ˆéœ€è¦è‡³å°‘${count}ä¸ªäº¤æ˜“æ—¥æ•°æ®ï¼‰`);
                }
                return arr.slice(-count).reduce((sum, value) => sum + value, 0) / count;
            };

            const ma5 = avg(closes, 5);
            const ma10 = avg(closes, 10);
            const ma20 = avg(closes, 20);
            const ma60 = closes.reduce((sum, value) => sum + value, 0) / closes.length;

            let gains = 0;
            let losses = 0;
            for (let i = 1; i < Math.min(closes.length, 14); i++) {
                const change = closes[closes.length - i] - closes[closes.length - i - 1];
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            const avgGain = gains / 14;
            const avgLoss = losses / 14;
            const rs = avgLoss === 0 ? 0 : avgGain / avgLoss;
            const rsi = avgLoss === 0 ? 100 : 100 - (100 / (1 + rs));

            const returns = [];
            for (let i = 1; i < closes.length; i++) {
                const prev = closes[i - 1];
                if (prev > 0) {
                    returns.push((closes[i] - prev) / prev);
                }
            }
            const avgReturn = returns.reduce((sum, ret) => sum + ret, 0) / (returns.length || 1);
            const variance = returns.reduce((sum, ret) => sum + Math.pow(ret - avgReturn, 2), 0) / (returns.length || 1);
            const volatility = Math.sqrt(variance) * Math.sqrt(252) * 100;

            const recentVolumes = volumes.slice(-10);
            const avgVolume = recentVolumes.reduce((sum, value) => sum + value, 0) / (recentVolumes.length || 1);
            const currentVolume = volumes[volumes.length - 1] || 0;
            const volumeRatio = avgVolume > 0 ? currentVolume / avgVolume : 0;

            return {
                ma5, ma10, ma20, ma60, rsi, volatility,
                current_price: currentPrice,
                volume_ratio: volumeRatio
            };
        }
        
        // åˆ†æèµ„é‡‘æµå‘
        function analyzeMoneyFlow(moneyFlowData) {
            if (!Array.isArray(moneyFlowData) || moneyFlowData.length === 0) {
                throw new Error('ç¼ºå°‘èµ„é‡‘æµå‘æ•°æ®ï¼Œæ— æ³•è¿›è¡Œåˆ†æ');
            }

            const recent = moneyFlowData.slice(-10);
            let mainNetFlow = 0;
            let superLargeNetFlow = 0;
            let positiveDays = 0;

            recent.forEach(item => {
                const net = Number(item.net_amount ?? item.net_mf_amount ?? 0);
                const superBuy = Number(item.buy_elg_amount ?? 0) + Number(item.buy_lg_amount ?? 0);
                const superSell = Number(item.sell_elg_amount ?? 0) + Number(item.sell_lg_amount ?? 0);

                mainNetFlow += net;
                superLargeNetFlow += (superBuy - superSell);

                if (net > 0) positiveDays++;
            });

            let mainTrend = 'å‡è¡¡';
            if (mainNetFlow > 100000000) {
                mainTrend = 'å¼ºåŠ¿å¸ç­¹';
            } else if (mainNetFlow > 0) {
                mainTrend = 'æ¸©å’Œæµå…¥';
            } else if (mainNetFlow < -100000000) {
                mainTrend = 'å¼ºåŠ¿å‡ºè´§';
            } else if (mainNetFlow < 0) {
                mainTrend = 'æ¸©å’Œæµå‡º';
            }

            const mainStrength = Math.abs(mainNetFlow) / 100000000;
            const superLargeActivity = Math.abs(superLargeNetFlow) / 100000000;
            const continuity = recent.length ? positiveDays / recent.length : 0;

            return {
                main_trend: mainTrend,
                main_strength: mainStrength,
                super_large_activity: superLargeActivity,
                continuity: continuity
            };
        }
        
        // åˆ†æå¤§å•å¼‚åŠ¨
        function analyzeLargeOrders(largeOrdersData) {
            if (!Array.isArray(largeOrdersData) || largeOrdersData.length === 0) {
                throw new Error('ç¼ºå°‘å¤§å•æ•°æ®ï¼Œæ— æ³•åˆ†æ');
            }

            let totalBuyAmount = 0;
            let totalSellAmount = 0;
            let anomalyCount = 0;

            largeOrdersData.forEach(order => {
                const buyAmount = Number(order.buyAmount || 0);
                const sellAmount = Number(order.sellAmount || 0);

                totalBuyAmount += buyAmount;
                totalSellAmount += sellAmount;

                if (buyAmount > 1000 || sellAmount > 1000) { // å•æ—¥ç‰¹å¤§+å¤§å•è¶…è¿‡äº¿å…ƒ
                    anomalyCount++;
                }
            });

            const buySellRatio = totalSellAmount > 0 ? totalBuyAmount / totalSellAmount : 1;
            const anomalyStrength = anomalyCount / largeOrdersData.length;
            const frequency = largeOrdersData.length;

            return {
                anomaly_strength: anomalyStrength,
                buy_sell_ratio: buySellRatio,
                frequency: frequency
            };
        }
        
        // å¢å¼ºç‰ˆæŠ•èµ„å¤§å¸ˆåˆ†æ
        function enhancedMasterAnalysis(indicators, moneyFlowAnalysis, largeOrdersAnalysis, stockInfo) {
            const strategies = {};
            
            // å·´è²ç‰¹ä»·å€¼æŠ•èµ„ç­–ç•¥ (æ›´å¤æ‚çš„è¯„åˆ†é€»è¾‘)
            let buffettScore = 50;
            
            // ä»·æ ¼ç›¸å¯¹äºå‡çº¿çš„ä½ç½®
            if (indicators.current_price < indicators.ma20) buffettScore += 15; // ä»·æ ¼ä½äºå‡çº¿ï¼Œä»·å€¼æœºä¼š
            if (indicators.current_price < indicators.ma60) buffettScore += 10; // é•¿æœŸå‡çº¿ä¸‹æ–¹
            
            // æ³¢åŠ¨ç‡ - å·´è²ç‰¹å–œæ¬¢ç¨³å®šçš„è‚¡ç¥¨
            if (indicators.volatility < 20) buffettScore += 20;
            else if (indicators.volatility > 40) buffettScore -= 15;
            
            // RSI - ä¸è¦è¿‡çƒ­
            if (indicators.rsi < 40) buffettScore += 15; // è¶…å–åŒºåŸŸ
            else if (indicators.rsi > 70) buffettScore -= 20; // è¶…ä¹°åŒºåŸŸ
            
            // èµ„é‡‘æµå‘ - ä¸»åŠ›èµ„é‡‘æŒç»­æµå…¥æ˜¯å¥½ä¿¡å·
            if (moneyFlowAnalysis.main_trend === 'å¼ºåŠ¿å¸ç­¹') buffettScore += 15;
            if (moneyFlowAnalysis.continuity > 0.6) buffettScore += 10; // æŒç»­æ€§å¥½
            
            strategies.buffett = Math.max(0, Math.min(100, buffettScore));
            
            // å½¼å¾—Â·æ—å¥‡æˆé•¿æŠ•èµ„ç­–ç•¥
            let lynchScore = 50;
            
            // è¶‹åŠ¿è·Ÿéš
            if (indicators.ma5 > indicators.ma10 && indicators.ma10 > indicators.ma20) lynchScore += 25;
            if (indicators.current_price > indicators.ma5) lynchScore += 15;
            
            // æˆäº¤é‡é…åˆ
            if (indicators.volume_ratio > 1.5) lynchScore += 15; // æ”¾é‡ä¸Šæ¶¨
            
            // RSIé€‚ä¸­åå¼º
            if (indicators.rsi > 50 && indicators.rsi < 75) lynchScore += 10;
            
            // è¶…å¤§å•æ´»è·ƒåº¦
            if (moneyFlowAnalysis.super_large_activity > 1) lynchScore += 15;
            
            strategies.lynch = Math.max(0, Math.min(100, lynchScore));
            
            // æœ¬æ°æ˜Â·æ ¼é›·å„å§†é˜²å¾¡æŠ•èµ„ç­–ç•¥
            let grahamScore = 50;
            
            // å®‰å…¨è¾¹é™… - ä»·æ ¼ä½äºé•¿æœŸå‡çº¿
            if (indicators.current_price < indicators.ma60) grahamScore += 20;
            
            // ä½æ³¢åŠ¨ç‡
            if (indicators.volatility < 25) grahamScore += 20;
            else if (indicators.volatility > 35) grahamScore -= 15;
            
            // ä¸è¿½é«˜
            if (indicators.rsi < 60) grahamScore += 15;
            else if (indicators.rsi > 75) grahamScore -= 25;
            
            // èµ„é‡‘æµå‘ç¨³å®š
            if (moneyFlowAnalysis.main_strength < 2 && moneyFlowAnalysis.main_trend !== 'å¼ºåŠ¿å‡ºè´§') {
                grahamScore += 10;
            }
            
            strategies.graham = Math.max(0, Math.min(100, grahamScore));
            
            // ç´¢ç½—æ–¯è¶‹åŠ¿æŠ•èµ„ç­–ç•¥
            let sorosScore = 50;
            
            // å¼ºè¶‹åŠ¿
            if (indicators.ma5 > indicators.ma10 && indicators.ma10 > indicators.ma20) sorosScore += 20;
            if (indicators.current_price > indicators.ma20) sorosScore += 15;
            
            // åŠ¨é‡
            if (indicators.rsi > 60) sorosScore += 15;
            if (indicators.volume_ratio > 2) sorosScore += 20; // å¤§å¹…æ”¾é‡
            
            // èµ„é‡‘æµå‘å¼ºåŠ¿
            if (moneyFlowAnalysis.main_trend === 'å¼ºåŠ¿å¸ç­¹') sorosScore += 20;
            if (moneyFlowAnalysis.super_large_activity > 2) sorosScore += 10;
            
            strategies.soros = Math.max(0, Math.min(100, sorosScore));
            
            // è®¡ç®—ç»¼åˆè¯„åˆ†
            const overallScore = (strategies.buffett + strategies.lynch + strategies.graham + strategies.soros) / 4;
            
            // ç¡®å®šæœ€ä½³ç­–ç•¥ - ä¿®å¤å¤šä¸ªç­–ç•¥å¾—åˆ†ç›¸åŒæ—¶çš„é€‰æ‹©é€»è¾‘
            const maxScore = Math.max(strategies.buffett, strategies.lynch, strategies.graham, strategies.soros);
            let bestStrategy = 'ç»¼åˆç­–ç•¥';
            
            // åˆ›å»ºç­–ç•¥å¾—åˆ†æ•°ç»„å¹¶æŒ‰å¾—åˆ†æ’åº
            const strategyList = [
                { name: 'å·´è²ç‰¹ä»·å€¼æŠ•èµ„', score: strategies.buffett, priority: 1 },
                { name: 'æ—å¥‡æˆé•¿æŠ•èµ„', score: strategies.lynch, priority: 2 },
                { name: 'æ ¼é›·å„å§†é˜²å¾¡æŠ•èµ„', score: strategies.graham, priority: 3 },
                { name: 'ç´¢ç½—æ–¯è¶‹åŠ¿æŠ•èµ„', score: strategies.soros, priority: 4 }
            ];
            
            // æŒ‰å¾—åˆ†é™åºæ’åºï¼Œå¾—åˆ†ç›¸åŒæ—¶æŒ‰ä¼˜å…ˆçº§æ’åº
            strategyList.sort((a, b) => {
                if (a.score !== b.score) {
                    return b.score - a.score; // å¾—åˆ†é«˜çš„åœ¨å‰
                }
                return a.priority - b.priority; // å¾—åˆ†ç›¸åŒæ—¶æŒ‰ä¼˜å…ˆçº§
            });
            
            // é€‰æ‹©å¾—åˆ†æœ€é«˜çš„ç­–ç•¥
            bestStrategy = strategyList[0].name;
            
            return {
                overall_score: overallScore,
                best_strategy: bestStrategy,
                strategy_breakdown: strategies,
                confidence: Math.min(95, 60 + (maxScore - 50) * 0.7) // ç½®ä¿¡åº¦è®¡ç®—
            };
        }
        
        // ç”ŸæˆæŠ•èµ„å»ºè®®
        function generateInvestmentAdvice(masterAnalysis, indicators, moneyFlowAnalysis) {
            const score = masterAnalysis.overall_score;
            const confidence = masterAnalysis.confidence;
            
            let recommendation = 'è§‚æœ›';
            let riskLevel = 'ä¸­ç­‰';
            let reasoning = [];
            
            if (score >= 75) {
                recommendation = confidence > 80 ? 'å¼ºçƒˆä¹°å…¥' : 'ä¹°å…¥';
                riskLevel = 'è¾ƒä½';
                reasoning.push('å¤šé¡¹æŠ€æœ¯æŒ‡æ ‡æ˜¾ç¤ºç§¯æä¿¡å·');
                reasoning.push('æŠ•èµ„å¤§å¸ˆç­–ç•¥è¯„åˆ†è¾ƒé«˜');
            } else if (score >= 60) {
                recommendation = 'è°¨æ…ä¹°å…¥';
                riskLevel = 'ä¸­ç­‰';
                reasoning.push('æŠ€æœ¯é¢æ•´ä½“åå¥½');
                reasoning.push('å»ºè®®åˆ†æ‰¹å»ºä»“');
            } else if (score <= 35) {
                recommendation = confidence > 70 ? 'å–å‡º' : 'è°¨æ…å–å‡º';
                riskLevel = 'è¾ƒé«˜';
                reasoning.push('å¤šé¡¹æŒ‡æ ‡æ˜¾ç¤ºé£é™©ä¿¡å·');
                reasoning.push('å»ºè®®è§„é¿é£é™©');
            } else {
                recommendation = 'è§‚æœ›';
                riskLevel = 'ä¸­ç­‰';
                reasoning.push('å¸‚åœºä¿¡å·ä¸æ˜ç¡®');
                reasoning.push('ç­‰å¾…æ›´å¥½çš„å…¥åœºæ—¶æœº');
            }
            
            // åŸºäºèµ„é‡‘æµå‘è°ƒæ•´å»ºè®®
            if (moneyFlowAnalysis.main_trend === 'å¼ºåŠ¿å‡ºè´§' && recommendation.includes('ä¹°å…¥')) {
                recommendation = 'è§‚æœ›';
                reasoning.push('ä¸»åŠ›èµ„é‡‘æµå‡ºï¼Œæš‚ç¼“ä¹°å…¥');
            }
            
            if (moneyFlowAnalysis.main_trend === 'å¼ºåŠ¿å¸ç­¹' && recommendation === 'è§‚æœ›') {
                recommendation = 'è°¨æ…ä¹°å…¥';
                reasoning.push('ä¸»åŠ›èµ„é‡‘æµå…¥ï¼Œå¯è€ƒè™‘å»ºä»“');
            }
            
            return {
                recommendation,
                confidence,
                risk_level: riskLevel,
                reasoning: reasoning.join('ï¼›')
            };
        }
        
        // ç”ŸæˆæŠ•èµ„æ´å¯Ÿ
        function generateMasterInsights(indicators, moneyFlowAnalysis, largeOrdersAnalysis, masterAnalysis) {
            const insights = [];
            
            // æŠ€æœ¯é¢æ´å¯Ÿ
            if (indicators.ma5 > indicators.ma10 && indicators.ma10 > indicators.ma20) {
                insights.push('ğŸ“ˆ å¤šå¤´æ’åˆ—ï¼šçŸ­ä¸­é•¿æœŸå‡çº¿å‘ˆå¤šå¤´æ’åˆ—ï¼ŒæŠ€æœ¯é¢åå¼º');
            } else if (indicators.ma5 < indicators.ma10 && indicators.ma10 < indicators.ma20) {
                insights.push('ğŸ“‰ ç©ºå¤´æ’åˆ—ï¼šçŸ­ä¸­é•¿æœŸå‡çº¿å‘ˆç©ºå¤´æ’åˆ—ï¼ŒæŠ€æœ¯é¢åå¼±');
            }
            
            // RSIæ´å¯Ÿ
            if (indicators.rsi > 70) {
                insights.push('âš ï¸ è¶…ä¹°è­¦å‘Šï¼šRSIæŒ‡æ ‡æ˜¾ç¤ºè¶…ä¹°ï¼Œæ³¨æ„å›è°ƒé£é™©');
            } else if (indicators.rsi < 30) {
                insights.push('ğŸ’¡ è¶…å–æœºä¼šï¼šRSIæŒ‡æ ‡æ˜¾ç¤ºè¶…å–ï¼Œå¯èƒ½å­˜åœ¨åå¼¹æœºä¼š');
            }
            
            // æ³¢åŠ¨ç‡æ´å¯Ÿ
            if (indicators.volatility > 35) {
                insights.push('ğŸŒŠ é«˜æ³¢åŠ¨ï¼šè‚¡ä»·æ³¢åŠ¨è¾ƒå¤§ï¼Œé€‚åˆçŸ­çº¿æ“ä½œï¼Œé•¿çº¿æŠ•èµ„éœ€è°¨æ…');
            } else if (indicators.volatility < 15) {
                insights.push('ğŸ”ï¸ ä½æ³¢åŠ¨ï¼šè‚¡ä»·ç›¸å¯¹ç¨³å®šï¼Œé€‚åˆç¨³å¥å‹æŠ•èµ„è€…');
            }
            
            // èµ„é‡‘æµå‘æ´å¯Ÿ
            if (moneyFlowAnalysis.main_trend === 'å¼ºåŠ¿å¸ç­¹') {
                insights.push('ğŸ’° ä¸»åŠ›çœ‹å¥½ï¼šä¸»åŠ›èµ„é‡‘æŒç»­æµå…¥ï¼Œæœºæ„æŠ•èµ„è€…çœ‹å¥½åå¸‚');
            } else if (moneyFlowAnalysis.main_trend === 'å¼ºåŠ¿å‡ºè´§') {
                insights.push('ğŸš¨ ä¸»åŠ›æ’¤ç¦»ï¼šä¸»åŠ›èµ„é‡‘å¤§å¹…æµå‡ºï¼Œéœ€è­¦æƒ•ä¸‹è·Œé£é™©');
            }
            
            if (moneyFlowAnalysis.super_large_activity > 2) {
                insights.push('ğŸ‹ è¶…å¤§å•æ´»è·ƒï¼šè¶…å¤§å•äº¤æ˜“é¢‘ç¹ï¼Œå¯èƒ½æœ‰é‡è¦æ¶ˆæ¯æˆ–æœºæ„è°ƒä»“');
            }
            
            // æˆäº¤é‡æ´å¯Ÿ
            if (indicators.volume_ratio > 2) {
                insights.push('ğŸ“Š æ”¾é‡æ˜æ˜¾ï¼šæˆäº¤é‡å¤§å¹…æ”¾å¤§ï¼Œå¸‚åœºå…³æ³¨åº¦é«˜');
            } else if (indicators.volume_ratio < 0.5) {
                insights.push('ğŸ“‰ ç¼©é‡æ•´ç†ï¼šæˆäº¤é‡èç¼©ï¼Œå¸‚åœºè§‚æœ›æƒ…ç»ªæµ“åš');
            }
            
            // ç­–ç•¥æ´å¯Ÿ
            const bestStrategy = masterAnalysis.best_strategy;
            if (bestStrategy === 'å·´è²ç‰¹ä»·å€¼æŠ•èµ„') {
                insights.push('ğŸ¯ ä»·å€¼æŠ•èµ„æœºä¼šï¼šå½“å‰ä»·æ ¼å¯èƒ½ä½ä¼°ï¼Œé€‚åˆé•¿æœŸä»·å€¼æŠ•èµ„');
            } else if (bestStrategy === 'æ—å¥‡æˆé•¿æŠ•èµ„') {
                insights.push('ğŸš€ æˆé•¿æŠ•èµ„æœºä¼šï¼šæŠ€æœ¯é¢æ˜¾ç¤ºæˆé•¿æ½œåŠ›ï¼Œé€‚åˆæˆé•¿å‹æŠ•èµ„');
            } else if (bestStrategy === 'ç´¢ç½—æ–¯è¶‹åŠ¿æŠ•èµ„') {
                insights.push('ğŸ“ˆ è¶‹åŠ¿æŠ•èµ„æœºä¼šï¼šè¶‹åŠ¿æ˜ç¡®ï¼Œé€‚åˆè¶‹åŠ¿è·Ÿéšç­–ç•¥');
            }
            
            return insights;
        }
        
        // æ‰“å¼€æ™ºèƒ½ä¸ªè‚¡åˆ†æé¡µé¢
        function openSmartAnalysis() {
            // ä¼˜å…ˆå–ä»£ç è¾“å…¥æ¡†çš„å€¼ï¼Œå¦‚æœä¸ºç©ºåˆ™å–å…¨å±€å˜é‡
            let code = document.getElementById('stockCode').value.trim();
            let name = '';
            
            if (!code) {
                code = globalCurrentStockCode || '';
                name = globalCurrentStockName || '';
            }
            
            if (code && /^\d{6}$/.test(code)) {
                // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œå…¼å®¹file://åè®®
                const url = `æ™ºèƒ½ä¸ªè‚¡åˆ†æ.html##${code}##${encodeURIComponent(name)}##`;
                window.location.href = url;
            } else {
                alert('è¯·å…ˆè¾“å…¥æˆ–åˆ†æè‚¡ç¥¨ä»£ç ');
            }
        }

        // æ¸…ç©ºç¼“å­˜å’Œé‡ç½®æ•°æ®
        function clearCacheAndReset() {
            // æ¸…é™¤æ˜¾ç¤ºå†…å®¹
            const masterScore = document.getElementById('masterScore');
            if (masterScore) masterScore.innerHTML = '';
            
            const strategyBreakdown = document.getElementById('strategyBreakdown');
            if (strategyBreakdown) strategyBreakdown.innerHTML = '';
            
            const recommendation = document.getElementById('recommendation');
            if (recommendation) recommendation.innerHTML = '';
            
            const analysisBasis = document.getElementById('analysisBasis');
            if (analysisBasis) analysisBasis.innerHTML = '';
            
            const masterInsights = document.getElementById('masterInsights');
            if (masterInsights) masterInsights.innerHTML = '';
        }

        // é€šè¾¾ä¿¡å¹¿æ’­åŠŸèƒ½ - é€šç”¨å‡½æ•°
        async function broadcastToTdx(stockCode) {
            try {
                console.log('æ­£åœ¨å¹¿æ’­è‚¡ç¥¨ä»£ç åˆ°é€šè¾¾ä¿¡:', stockCode);
                const serverUrl = getServerUrl();
                console.log('ä½¿ç”¨æœåŠ¡å™¨åœ°å€:', serverUrl);
                
                const response = await fetch(`${serverUrl}/api/broadcast`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stock_code: stockCode
                    })
                });
                
                console.log('å¹¿æ’­å“åº”çŠ¶æ€:', response.status);
                const result = await response.json();
                console.log('å¹¿æ’­å“åº”ç»“æœ:', result);
                
                if (result.success) {
                    console.log('âœ“ æˆåŠŸå¹¿æ’­è‚¡ç¥¨ä»£ç åˆ°é€šè¾¾ä¿¡:', stockCode);
                } else {
                    console.warn('âœ— å¹¿æ’­è‚¡ç¥¨ä»£ç åˆ°é€šè¾¾ä¿¡å¤±è´¥:', result.error);
                }
            } catch (error) {
                console.error('âœ— å¹¿æ’­è‚¡ç¥¨ä»£ç åˆ°é€šè¾¾ä¿¡æ—¶å‘ç”Ÿé”™è¯¯:', error);
            }
        }
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                max-width: 300px;
                word-wrap: break-word;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
        
        // ä¸»åˆ†æå‡½æ•°
        async function analyzeStock() {
            const stockCode = document.getElementById('stockCode').value.trim();
            
            if (!stockCode) {
                showError('è¯·è¾“å…¥6ä½è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            // å¹¿æ’­åˆ°é€šè¾¾ä¿¡
            broadcastToTdx(stockCode);
            
            // æ¸…ç©ºä¸Šä¸€æ¬¡çš„ç»“æœ
            clearCacheAndReset();
            
            window.currentAnalyzedCode = stockCode; // å½“å‰åˆ†æçš„è‚¡ç¥¨ä»£ç 
            globalCurrentStockCode = stockCode; // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä¾¿äºå…¶ä»–æ¨¡å—ä½¿ç”¨
            
            if (!validateStockCode(stockCode)) {
                showError('è‚¡ç¥¨ä»£ç å¿…é¡»ä¸º6ä½æ•°å­—');
                return;
            }
            
            showLoading();
            
            try {
                // å¹¶è¡Œæ‹‰å–åŸºç¡€ä¿¡æ¯ã€è¡Œæƒ…æ•°æ®å’Œèµ„é‡‘æµå‘æ•°æ®
                const [basicInfo, marketData, moneyFlowData] = await Promise.all([
                    fetchStockBasic(stockCode),
                    fetchStockMarket(stockCode),
                    fetchMoneyFlow(stockCode)
                ]);

                const largeOrdersData = await fetchLargeOrders(stockCode, moneyFlowData);
                
                // æ›´æ–°è‚¡ç¥¨åç§°ç¼“å­˜
                if (basicInfo && basicInfo.name) {
                    globalCurrentStockName = basicInfo.name;
                }
                
                // è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
                const indicators = calculateTechnicalIndicators(marketData);
                
                // åˆ†æèµ„é‡‘æµå‘
                const moneyFlowAnalysis = analyzeMoneyFlow(moneyFlowData);
                
                // åˆ†æå¤§å•åŠ¨å‘
                const largeOrdersAnalysis = analyzeLargeOrders(largeOrdersData);
                
                // ç»¼åˆå¤§å¸ˆç­–ç•¥åˆ†æ
                const masterAnalysis = enhancedMasterAnalysis(indicators, moneyFlowAnalysis, largeOrdersAnalysis, basicInfo);
                
                // ç»™å‡ºæŠ•èµ„å»ºè®®
                const investmentAdvice = generateInvestmentAdvice(masterAnalysis, indicators, moneyFlowAnalysis);
                
                // æ´å¯Ÿæ€»ç»“
                const masterInsights = generateMasterInsights(indicators, moneyFlowAnalysis, largeOrdersAnalysis, masterAnalysis);
                
                // å±•ç¤ºç»“æœ
                displayResults(basicInfo, masterAnalysis, investmentAdvice, masterInsights, {
                    market: marketData ? marketData.length : 0,
                    moneyFlow: Array.isArray(moneyFlowData) ? moneyFlowData.length : 0,
                    largeOrders: Array.isArray(largeOrdersData) ? largeOrdersData.length : 0
                });
                
                showResults();
                
            } catch (error) {
                // æ•è·é”™è¯¯å¹¶æç¤º
                let errorMessage = '';
                if (error.message) {
                    errorMessage = `å‘ç”Ÿé”™è¯¯: ${error.message}`;
                } else if (typeof error === 'string') {
                    errorMessage = `å‘ç”Ÿé”™è¯¯: ${error}`;
                } else {
                    errorMessage = 'åˆ†æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                }
                showError(errorMessage);
            }
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResults(stockInfo, masterAnalysis, investmentAdvice, insights, dataSources) {
            // æ˜¾ç¤ºç»¼åˆè¯„åˆ†
            displayMasterScore(masterAnalysis);
            
            // æ˜¾ç¤ºæŠ•èµ„å»ºè®®
            displayRecommendation(investmentAdvice, dataSources);
            
            // æ˜¾ç¤ºæŠ•èµ„æ´å¯Ÿ
            displayInsights(insights);
        }
        
        // æ˜¾ç¤ºæŠ•èµ„å¤§å¸ˆè¯„åˆ†
        function displayMasterScore(masterAnalysis) {
            const score = masterAnalysis.overall_score;
            const scoreElement = document.getElementById('masterScore');
            
            let scoreClass = 'score-poor';
            if (score >= 75) scoreClass = 'score-excellent';
            else if (score >= 60) scoreClass = 'score-good';
            else if (score >= 45) scoreClass = 'score-average';
            
            scoreElement.innerHTML = `
                <div class="score-circle ${scoreClass}">
                    ${score.toFixed(1)}
                </div>
                <p><strong>æœ€ä½³ç­–ç•¥:</strong> ${masterAnalysis.best_strategy}</p>
                <p><strong>ç½®ä¿¡åº¦:</strong> ${masterAnalysis.confidence.toFixed(1)}%</p>
            `;
            
            // æ˜¾ç¤ºç­–ç•¥åˆ†è§£
            const breakdownElement = document.getElementById('strategyBreakdown');
            const strategies = masterAnalysis.strategy_breakdown;
            const strategyNames = {
                buffett: 'å·´è²ç‰¹ä»·å€¼æŠ•èµ„',
                lynch: 'æ—å¥‡æˆé•¿æŠ•èµ„',
                graham: 'æ ¼é›·å„å§†é˜²å¾¡æŠ•èµ„',
                soros: 'ç´¢ç½—æ–¯è¶‹åŠ¿æŠ•èµ„'
            };
            
            let breakdownHtml = '';
            Object.entries(strategies).forEach(([key, score]) => {
                const name = strategyNames[key] || key;
                let scoreClass = 'score-low';
                if (score >= 70) scoreClass = 'score-high';
                else if (score >= 50) scoreClass = 'score-medium';
                
                breakdownHtml += `
                    <div class="strategy-item">
                        <span class="strategy-name">${name}</span>
                        <span class="strategy-score ${scoreClass}">${score.toFixed(1)}</span>
                    </div>
                `;
            });
            
            breakdownElement.innerHTML = breakdownHtml;
        }
        
        // æ˜¾ç¤ºæŠ•èµ„å»ºè®®
        function displayRecommendation(advice, dataSources) {
            const recElement = document.getElementById('recommendation');
            
            let recClass = 'rec-hold';
            if (advice.recommendation.includes('ä¹°å…¥')) recClass = 'rec-buy';
            else if (advice.recommendation.includes('å–å‡º')) recClass = 'rec-sell';
            
            recElement.innerHTML = `
                <div class="recommendation ${recClass}">
                    <h3>${advice.recommendation}</h3>
                    <p><strong>ç½®ä¿¡åº¦:</strong> ${advice.confidence.toFixed(1)}%</p>
                    <p><strong>é£é™©ç­‰çº§:</strong> ${advice.risk_level}</p>
                </div>
                <p><strong>ä¸»è¦ä¾æ®:</strong> ${advice.reasoning}</p>
            `;
            
            const basisElement = document.getElementById('analysisBasis');
            basisElement.innerHTML = `
                <li>æŠ€æœ¯é¢åˆ†æï¼ˆKçº¿æ ·æœ¬: ${dataSources.market} æ¡ï¼‰</li>
                <li>èµ„é‡‘é¢åˆ†æï¼ˆèµ„é‡‘æµå‘æ ·æœ¬: ${dataSources.moneyFlow} æ¡ï¼‰</li>
                <li>å¤§å•åŠ¨å‘ï¼ˆç‰¹å¤§+å¤§å•æ ·æœ¬: ${dataSources.largeOrders} æ¡ï¼‰</li>
                <li>å¤šç»´å¤§å¸ˆç­–ç•¥æ¨¡å‹ç»¼åˆè¯„åˆ†</li>
                <li>å¸‚åœºæƒ…ç»ªä¸ä¸»åŠ›èµ„é‡‘è¡Œä¸ºè¯„ä¼°</li>
            `;
        }
        
        // æ˜¾ç¤ºæŠ•èµ„æ´å¯Ÿ
        function displayInsights(insights) {
            const insightsElement = document.getElementById('masterInsights');
            
            if (insights.length === 0) {
                insightsElement.innerHTML = '<li>æš‚æ— ç‰¹åˆ«æ´å¯Ÿ</li>';
                return;
            }
            
            const insightsHtml = insights.map(insight => `<li>${insight}</li>`).join('');
            insightsElement.innerHTML = insightsHtml;
        }
        
        // å›è½¦é”®æœç´¢
        document.getElementById('stockCode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                analyzeStock();
            }
        });
        
        // è·å–URLå‚æ•°ï¼ˆä½¿ç”¨##åˆ†éš”ç¬¦ï¼‰- ä»“åº“è°ƒç”¨åŠŸèƒ½
        function getUrlParams() {
            // è·å–hashå†…å®¹
            let hashContent = window.location.hash;
            
            // ç§»é™¤å¼€å¤´çš„#ç¬¦å·
            while (hashContent.startsWith('#')) {
                hashContent = hashContent.substring(1);
            }

            // å¦‚æœæ²¡æœ‰hashå†…å®¹ï¼Œè¿”å›ç©ºå‚æ•°
            if (!hashContent) {
                return { code: '', name: '' };
            }

            // URLè§£ç ï¼ˆå¤„ç†%23ç­‰ç¼–ç å­—ç¬¦ï¼‰
            try {
                hashContent = decodeURIComponent(hashContent);
            } catch (e) {
                console.error('URLè§£ç å¤±è´¥:', e);
            }

            // è§£ç åå¯èƒ½è¿˜æœ‰å‰å¯¼#ï¼Œå†æ¬¡ç§»é™¤
            while (hashContent.startsWith('#')) {
                hashContent = hashContent.substring(1);
            }

            // æŒ‰##åˆ†å‰²
            const parts = hashContent.split('##');

            // æ”¯æŒå¤šç§æ ¼å¼ï¼š##ä»£ç ##åç§°##ã€##ä»£ç ##ã€##ä»£ç 
            let code = '';
            let name = '';
            
            if (parts.length >= 1) {
                code = parts[0] || '';
                // å¦‚æœæœ‰ç¬¬äºŒéƒ¨åˆ†ï¼Œä½¿ç”¨å®ƒä½œä¸ºåç§°ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
                if (parts.length >= 2) {
                    name = decodeURIComponent(parts[1] || ''); // è§£ç URLç¼–ç çš„ä¸­æ–‡å­—ç¬¦
                }
                
                // ç§»é™¤ä»£ç å‰é¢å¯èƒ½çš„#ç¬¦å·
                while (code.startsWith('#')) {
                    code = code.substring(1);
                }
                
                // éªŒè¯è‚¡ç¥¨ä»£ç æ ¼å¼
                if (code && /^\d{6}$/.test(code)) {
                    return {
                        code: code,
                        name: name
                    };
                }
            }

            return {
                code: '',
                name: ''
            };
        }

        // åˆå§‹åŒ–é¡µé¢ - æ”¯æŒä»“åº“è°ƒç”¨
        function initPage() {
            // è·å–URLå‚æ•°
            const params = getUrlParams();
            
            if (params.code && /^\d{6}$/.test(params.code)) {
                // å¦‚æœæœ‰æœ‰æ•ˆçš„URLå‚æ•°ï¼Œè‡ªåŠ¨è®¾ç½®è‚¡ç¥¨ä»£ç å¹¶åˆ†æ
                document.getElementById('stockCode').value = params.code;
                // ä¿å­˜åˆ°å…¨å±€å˜é‡
                globalCurrentStockCode = params.code;
                globalCurrentStockName = params.name || '';
                
                // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿é¡µé¢å®Œå…¨åˆå§‹åŒ–åå†åˆ†æ
                setTimeout(() => {
                    analyzeStock();
                }, 500);
            } else {
                // æ²¡æœ‰æœ‰æ•ˆå‚æ•°ï¼Œä¿æŒè¾“å…¥æ¡†ä¸ºç©º
                document.getElementById('stockCode').value = '';
                }
        }

        // ç›‘å¬URLå˜åŒ–ï¼ˆåŒ…æ‹¬hashå˜åŒ–ï¼‰- æ”¯æŒä»“åº“è°ƒç”¨
        window.addEventListener('hashchange', function(event) {
            // é‡æ–°åˆå§‹åŒ–é¡µé¢ä»¥å¤„ç†æ–°çš„URLå‚æ•°
            initPage();
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            initPage();
        });
    </script>

    <!-- é£é™©è­¦å‘Š -->
    <div class="risk-warning">
        <strong>é£é™©æç¤ºï¼š</strong>æœ¬é¡µé¢æ•°æ®ä»…ä¾›å‚è€ƒï¼Œä¸åšä¸ºæŠ•èµ„æ¨èåŠå»ºè®®ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ã€‚<br>
        è‚¡ç¥¨æŠ•èµ„å­˜åœ¨ä»·æ ¼æ³¢åŠ¨é£é™©ï¼Œè¿‡å¾€ä¸šç»©ä¸ä»£è¡¨æœªæ¥è¡¨ç°ï¼Œè¯·æ ¹æ®è‡ªèº«é£é™©æ‰¿å—èƒ½åŠ›è°¨æ…æŠ•èµ„ã€‚
    </div>

    <!-- GitHubé“¾æ¥ -->
    <div style="text-align: center; margin: 30px auto; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 15px; max-width: 1200px;">
        <p style="color: #b0c4de; margin-bottom: 10px;">å¼€æºé¡¹ç›®</p>
        <a href="https://github.com/hengruiyun" target="_blank" style="color: #4CAF50; text-decoration: none; font-weight: bold; font-size: 16px;">
            <i class="fab fa-github"></i> è®¿é—®GitHub @hengruiyun
        </a>
    </div>
</body>
</html>
